<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Lnterlink的小屋 | Lnterlink的小屋</title><meta name="author" content="Lnterlink"><meta name="copyright" content="Lnterlink"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Python B站爬虫代码阐释 组别：小组2 成员：马德盛 任毅 周子昂 李星宇 尹鹏贺 张圣涵  项目概述这是一个完整的B站(Bilibili)评论可视化数据采集与分析系统，由三个核心模块组成：  评论爬取模块 - 从指定B站视频爬取评论数据 视频搜索模块 - 根据关键词搜索相关视频 评论分析模块 - 对爬取的评论数据进行清洗和分析  系统已成功爬取超过50,000条评论和1,000+个视频数据">
<meta property="og:type" content="article">
<meta property="og:title" content="Lnterlink的小屋">
<meta property="og:url" content="https://lnterlink.site/2025/07/21/%E4%BB%A3%E7%A0%81%E5%8F%8A%E4%BB%A3%E7%A0%81%E9%98%90%E9%87%8A/index.html">
<meta property="og:site_name" content="Lnterlink的小屋">
<meta property="og:description" content="Python B站爬虫代码阐释 组别：小组2 成员：马德盛 任毅 周子昂 李星宇 尹鹏贺 张圣涵  项目概述这是一个完整的B站(Bilibili)评论可视化数据采集与分析系统，由三个核心模块组成：  评论爬取模块 - 从指定B站视频爬取评论数据 视频搜索模块 - 根据关键词搜索相关视频 评论分析模块 - 对爬取的评论数据进行清洗和分析  系统已成功爬取超过50,000条评论和1,000+个视频数据">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lnterlink.site/img/%E8%96%AF%E7%89%87%E5%85%8D%E6%89%A3%E5%9B%BE%E8%8A%B1%E8%84%B8.png">
<meta property="article:published_time" content="2025-07-21T11:37:45.300Z">
<meta property="article:modified_time" content="2025-07-21T11:19:08.171Z">
<meta property="article:author" content="Lnterlink">
<meta property="article:tag" content="关键词">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lnterlink.site/img/%E8%96%AF%E7%89%87%E5%85%8D%E6%89%A3%E5%9B%BE%E8%8A%B1%E8%84%B8.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "",
  "url": "https://lnterlink.site/2025/07/21/%E4%BB%A3%E7%A0%81%E5%8F%8A%E4%BB%A3%E7%A0%81%E9%98%90%E9%87%8A/",
  "image": "https://lnterlink.site/img/%E8%96%AF%E7%89%87%E5%85%8D%E6%89%A3%E5%9B%BE%E8%8A%B1%E8%84%B8.png",
  "datePublished": "2025-07-21T11:37:45.300Z",
  "dateModified": "2025-07-21T11:19:08.171Z",
  "author": [
    {
      "@type": "Person",
      "name": "Lnterlink",
      "url": "https://lnterlink.site/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://lnterlink.site/2025/07/21/%E4%BB%A3%E7%A0%81%E5%8F%8A%E4%BB%A3%E7%A0%81%E9%98%90%E9%87%8A/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":2,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Lnterlink的小屋',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E8%96%AF%E7%89%87%E5%85%8D%E6%89%A3%E5%9B%BE%E8%8A%B1%E8%84%B8.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/home-bg.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Lnterlink的小屋</span></a><a class="nav-page-title" href="/"><span class="site-name">Lnterlink的小屋</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">无标题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-21T11:37:45.300Z" title="发表于 2025-07-21 19:37:45">2025-07-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-21T11:19:08.171Z" title="更新于 2025-07-21 19:19:08">2025-07-21</time></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Python-B站爬虫代码阐释"><a href="#Python-B站爬虫代码阐释" class="headerlink" title="Python B站爬虫代码阐释"></a>Python B站爬虫代码阐释</h1><blockquote>
<p>组别：小组2</p>
<p>成员：马德盛 任毅 周子昂 李星宇 尹鹏贺 张圣涵</p>
</blockquote>
<h2 id="项目概述"><a href="#项目概述" class="headerlink" title="项目概述"></a>项目概述</h2><p>这是一个完整的B站(Bilibili)评论<strong>可视化</strong>数据采集与分析系统，由三个核心模块组成：</p>
<ol>
<li><strong>评论爬取模块</strong> - 从指定B站视频爬取评论数据</li>
<li><strong>视频搜索模块</strong> - 根据关键词搜索相关视频</li>
<li><strong>评论分析模块</strong> - 对爬取的评论数据进行清洗和分析</li>
</ol>
<p>系统已成功爬取超过50,000条评论和1,000+个视频数据，具有高效稳定的爬取能力。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ul>
<li>环境准备：使用conda作为环境与包管理器，python解释器版本推荐在3.6以上，打开cmd安装pandas、requests、fake_useragent三个外部依赖即可，具体安装环节参考百度，此处不展开</li>
<li>获取cookie：首先需要在网页端登陆B站，推荐使用chrome、edge等浏览器，登陆后按F12打开开发者模式，然后点击“网络&#x2F;network”，刷新一次页面，选择fetch&#x2F;HXR文档部分，选择一个名为“nav”的文件，下拉即可看到cookie，复制即可</li>
<li>打开sousuo_ver2.py，输入刚刚获取的cookie，并输入关键词，默认收集该关键词下播放量前50的视频BV号，BV号和输入的cookie会自动打包为相应的文件，无需管理</li>
<li>打开b_ver7.py，输入要爬取的评论数及二级评论数，点击爬取即默认加载刚刚爬取的BV号，默认为多视频合并爬取模式，方便大规模爬取，一般来说每个视频爬50个一级评论、每个一级评论爬10个二级评论是比较合适的比例，据测试效率在单机15000条评论每小时左右</li>
<li>打开quchong_ver4.py，加载刚刚爬取的评论，设置保存位置即可自动去重并筛选</li>
<li>最后记得人工过一遍筛选，避免错误</li>
</ul>
<h2 id="模块功能详解"><a href="#模块功能详解" class="headerlink" title="模块功能详解"></a>模块功能详解</h2><h3 id="1-评论爬取模块-b-ver7-py"><a href="#1-评论爬取模块-b-ver7-py" class="headerlink" title="1. 评论爬取模块 (b_ver7.py)"></a>1. 评论爬取模块 (b_ver7.py)</h3><h4 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h4><ul>
<li>支持单视频和多视频批量爬取模式</li>
<li>可爬取一级评论和二级回复评论</li>
<li>自动BV号转AID功能</li>
<li>评论去重处理</li>
<li>支持Cookie与fake_useragent设置绕过风控</li>
</ul>
<h4 id="技术特点"><a href="#技术特点" class="headerlink" title="技术特点"></a>技术特点</h4><ul>
<li><strong>多线程爬取</strong>：使用独立线程执行爬取任务，避免界面卡顿</li>
<li><strong>智能风控处理</strong>：检测到-412错误码时自动等待重试</li>
<li><strong>断点续爬</strong>：多视频模式下可保存中间结果</li>
<li><strong>高效存储</strong>：采用CSV格式存储，支持增量追加</li>
</ul>
<h4 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h4><ul>
<li>爬取速度：约200-500条评论&#x2F;分钟(取决于网络条件和风控策略)</li>
<li>支持每个视频爬取最多1000条一级评论</li>
<li>每个一级评论可爬取最多100条二级评论</li>
</ul>
<h3 id="2-视频搜索模块-sousuo-ver2-py"><a href="#2-视频搜索模块-sousuo-ver2-py" class="headerlink" title="2. 视频搜索模块 (sousuo_ver2.py)"></a>2. 视频搜索模块 (sousuo_ver2.py)</h3><h4 id="核心功能-1"><a href="#核心功能-1" class="headerlink" title="核心功能"></a>核心功能</h4><ul>
<li>按关键词搜索B站视频</li>
<li>结果按播放量降序排列</li>
<li>支持BV号列表导出</li>
<li>提供追加模式和去重功能</li>
</ul>
<h4 id="技术特点-1"><a href="#技术特点-1" class="headerlink" title="技术特点"></a>技术特点</h4><ul>
<li><strong>智能排序</strong>：自动按播放量排序返回结果</li>
<li><strong>结果去重</strong>：避免重复收录同一视频</li>
<li><strong>Cookie支持</strong>：可设置Cookie提高搜索成功率</li>
</ul>
<h4 id="性能指标-1"><a href="#性能指标-1" class="headerlink" title="性能指标"></a>性能指标</h4><ul>
<li>单次搜索可获取约50个高质量视频BV号</li>
<li>搜索速度：约200个视频&#x2F;分钟</li>
</ul>
<h3 id="3-评论分析模块-quchong-ver4-py"><a href="#3-评论分析模块-quchong-ver4-py" class="headerlink" title="3. 评论分析模块 (quchong_ver4.py)"></a>3. 评论分析模块 (quchong_ver4.py)</h3><h4 id="核心功能-2"><a href="#核心功能-2" class="headerlink" title="核心功能"></a>核心功能</h4><ul>
<li>评论数据去重(全字段或仅内容)</li>
<li>诗体评论识别与分析</li>
<li>多维度统计(点赞数、时间分布等)</li>
<li>结果导出(CSV&#x2F;Pkl)</li>
</ul>
<h4 id="技术特点-2"><a href="#技术特点-2" class="headerlink" title="技术特点"></a>技术特点</h4><ul>
<li><strong>诗体识别算法</strong>：基于换行符数量识别诗体评论</li>
<li><strong>灵活分析</strong>：支持多种排序和筛选条件</li>
<li><strong>可视化展示</strong>：提供清晰的统计图表</li>
</ul>
<h4 id="分析能力"><a href="#分析能力" class="headerlink" title="分析能力"></a>分析能力</h4><ul>
<li>可处理数万条评论数据集</li>
<li>诗体评论识别准确率&gt;90%</li>
</ul>
<h2 id="系统架构设计"><a href="#系统架构设计" class="headerlink" title="系统架构设计"></a>系统架构设计</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[视频搜索模块] --&gt;|生成BV号列表| B[评论爬取模块]</span><br><span class="line">    B --&gt;|输出CSV文件| C[评论分析模块]</span><br><span class="line">    C --&gt;|分析结果| D[可视化报告]</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>数据采集层</strong>：视频搜索和评论爬取模块</li>
<li><strong>数据处理层</strong>：评论清洗和分析模块</li>
<li><strong>应用层</strong>：生成可视化报告和导出功能</li>
</ol>
<h2 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h2><h3 id="基本工作流程"><a href="#基本工作流程" class="headerlink" title="基本工作流程"></a>基本工作流程</h3><ol>
<li>使用<strong>视频搜索模块</strong>获取目标视频BV号列表(注意将cookie保存在txt文本中)</li>
<li>使用<strong>评论爬取模块</strong>爬取这些视频的评论</li>
<li>使用<strong>评论分析模块</strong>对爬取的评论进行分析</li>
</ol>
<h3 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h3><ol>
<li><strong>合理设置爬取间隔</strong>：建议2-5秒&#x2F;请求，避免触发风控</li>
<li><strong>使用有效Cookie</strong>：可显著提高爬取成功率</li>
<li><strong>分批次爬取</strong>：对于大量视频，建议分批处理</li>
<li><strong>利用多视频模式</strong>：可自动合并多个视频的评论数据</li>
</ol>
<h2 id="扩展性与维护性"><a href="#扩展性与维护性" class="headerlink" title="扩展性与维护性"></a>扩展性与维护性</h2><ol>
<li><strong>模块化设计</strong>：各功能模块相互独立，便于维护</li>
<li><strong>配置灵活</strong>：关键参数均可通过界面调整</li>
<li><strong>日志完善</strong>：详细记录运行状态，便于排查问题</li>
<li><strong>异常处理</strong>：对常见错误有完善的恢复机制</li>
</ol>
<h2 id="代码展示与注释"><a href="#代码展示与注释" class="headerlink" title="代码展示与注释"></a>代码展示与注释</h2><h3 id="1-视频搜索模块（sousuo-ver2-py"><a href="#1-视频搜索模块（sousuo-ver2-py" class="headerlink" title="1.视频搜索模块（sousuo_ver2.py)"></a>1.视频搜索模块（sousuo_ver2.py)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> ttk, messagebox, filedialog</span><br><span class="line"><span class="keyword">from</span> fake_useragent <span class="keyword">import</span> UserAgent</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BiliBiliVideoCrawler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cookie: <span class="built_in">str</span> = <span class="literal">None</span>, log_callback=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.session = requests.Session()</span><br><span class="line">        <span class="variable language_">self</span>.ua = UserAgent()</span><br><span class="line">        <span class="variable language_">self</span>.cookie = cookie</span><br><span class="line">        <span class="variable language_">self</span>.log_callback = log_callback</span><br><span class="line">        <span class="variable language_">self</span>._update_headers()</span><br><span class="line">        <span class="variable language_">self</span>.running = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_log</span>(<span class="params">self, message: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录日志&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> message <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        timestamp = datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">        log_message = <span class="string">f&quot;[<span class="subst">&#123;timestamp&#125;</span>] <span class="subst">&#123;message&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.log_callback:</span><br><span class="line">            <span class="variable language_">self</span>.log_callback(log_message)</span><br><span class="line">        <span class="built_in">print</span>(log_message)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_update_headers</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新请求头&quot;&quot;&quot;</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;User-Agent&#x27;</span>: <span class="variable language_">self</span>.ua.random,</span><br><span class="line">            <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;https://www.bilibili.com/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Origin&#x27;</span>: <span class="string">&#x27;https://www.bilibili.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json, text/plain, */*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9,en;q=0.8&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.cookie:</span><br><span class="line">            headers[<span class="string">&#x27;Cookie&#x27;</span>] = <span class="variable language_">self</span>.cookie</span><br><span class="line">        <span class="variable language_">self</span>.session.headers.update(headers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;停止爬取&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.running = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>._log(<span class="string">&quot;正在停止爬取...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_videos</span>(<span class="params">self, keyword: <span class="built_in">str</span>, max_count: <span class="built_in">int</span> = <span class="number">50</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;搜索B站视频并返回BV号列表（按播放量降序）&quot;&quot;&quot;</span></span><br><span class="line">        bvids = []</span><br><span class="line">        page = <span class="number">1</span></span><br><span class="line">        per_page = <span class="number">20</span>  <span class="comment"># 每页视频数</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(bvids) &lt; max_count <span class="keyword">and</span> <span class="variable language_">self</span>.running:</span><br><span class="line">            url = <span class="string">f&quot;https://api.bilibili.com/x/web-interface/wbi/search/type?search_type=video&amp;keyword=<span class="subst">&#123;keyword&#125;</span>&amp;page=<span class="subst">&#123;page&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>._update_headers()</span><br><span class="line">                <span class="variable language_">self</span>._log(<span class="string">f&quot;正在获取第 <span class="subst">&#123;page&#125;</span> 页视频...&quot;</span>)</span><br><span class="line">                resp = <span class="variable language_">self</span>.session.get(url)</span><br><span class="line">                data = resp.json()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> data[<span class="string">&#x27;code&#x27;</span>] == -<span class="number">412</span>:</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">&quot;触发风控，等待30秒后重试...&quot;</span>)</span><br><span class="line">                    time.sleep(<span class="number">30</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> data[<span class="string">&#x27;code&#x27;</span>] != <span class="number">0</span>:</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">f&quot;搜索视频失败: <span class="subst">&#123;data[<span class="string">&#x27;message&#x27;</span>]&#125;</span> (code: <span class="subst">&#123;data[<span class="string">&#x27;code&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> data[<span class="string">&#x27;code&#x27;</span>] == -<span class="number">352</span>:</span><br><span class="line">                        <span class="variable language_">self</span>._log(<span class="string">&quot;建议：1.检查Cookie是否有效 2.增加请求间隔 3.使用代理IP&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                videos = data[<span class="string">&#x27;data&#x27;</span>].get(<span class="string">&#x27;result&#x27;</span>, [])</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> videos:</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">&quot;没有更多视频了&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 按播放量排序</span></span><br><span class="line">                sorted_videos = <span class="built_in">sorted</span>(videos, key=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;play&#x27;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> video <span class="keyword">in</span> sorted_videos:</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.running <span class="keyword">or</span> <span class="built_in">len</span>(bvids) &gt;= max_count:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">                    bvid = video.get(<span class="string">&#x27;bvid&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> bvid:</span><br><span class="line">                        bvids.append(bvid)</span><br><span class="line">                        <span class="variable language_">self</span>._log(<span class="string">f&quot;获取视频: <span class="subst">&#123;video[<span class="string">&#x27;title&#x27;</span>]&#125;</span> (BV: <span class="subst">&#123;bvid&#125;</span>, 播放量: <span class="subst">&#123;video[<span class="string">&#x27;play&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                page += <span class="number">1</span></span><br><span class="line">                time.sleep(<span class="number">2</span>)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>._log(<span class="string">f&quot;发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                time.sleep(<span class="number">5</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> bvids</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BiliBiliVideoSearchGUI</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="variable language_">self</span>.root = root</span><br><span class="line">        <span class="variable language_">self</span>.root.title(<span class="string">&quot;B站视频搜索工具&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.root.geometry(<span class="string">&quot;800x600&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cookie_file = <span class="string">&quot;bilibili_cookie.txt&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.output_file = <span class="string">&quot;bvid_list.txt&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.crawler = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.existing_bvids = <span class="built_in">set</span>()  <span class="comment"># 用于存储已存在的BV号</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取脚本所在目录</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">getattr</span>(sys, <span class="string">&#x27;frozen&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">            <span class="variable language_">self</span>.script_dir = os.path.dirname(sys.executable)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.script_dir = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建主框架</span></span><br><span class="line">        <span class="variable language_">self</span>.main_frame = ttk.Frame(root, padding=<span class="string">&quot;10&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.main_frame.pack(fill=BOTH, expand=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 关键词部分</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;搜索关键词:&quot;</span>).grid(row=<span class="number">0</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.keyword_entry = ttk.Entry(<span class="variable language_">self</span>.main_frame, width=<span class="number">50</span>)</span><br><span class="line">        <span class="variable language_">self</span>.keyword_entry.grid(row=<span class="number">1</span>, column=<span class="number">0</span>, columnspan=<span class="number">2</span>, sticky=(W, E), pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 视频数量</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;获取数量:&quot;</span>).grid(row=<span class="number">2</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.count_entry = ttk.Entry(<span class="variable language_">self</span>.main_frame, width=<span class="number">10</span>)</span><br><span class="line">        <span class="variable language_">self</span>.count_entry.insert(<span class="number">0</span>, <span class="string">&quot;50&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.count_entry.grid(row=<span class="number">3</span>, column=<span class="number">0</span>, sticky=W, pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 追加模式复选框</span></span><br><span class="line">        <span class="variable language_">self</span>.append_mode_var = BooleanVar(value=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.append_mode_check = ttk.Checkbutton(</span><br><span class="line">            <span class="variable language_">self</span>.main_frame, </span><br><span class="line">            text=<span class="string">&quot;追加模式(保留之前结果并去重)&quot;</span>, </span><br><span class="line">            variable=<span class="variable language_">self</span>.append_mode_var</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.append_mode_check.grid(row=<span class="number">3</span>, column=<span class="number">1</span>, sticky=W, padx=(<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cookie部分</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;B站Cookie (可选):&quot;</span>).grid(row=<span class="number">4</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.cookie_entry = ttk.Entry(<span class="variable language_">self</span>.main_frame, width=<span class="number">50</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cookie_entry.grid(row=<span class="number">5</span>, column=<span class="number">0</span>, columnspan=<span class="number">2</span>, sticky=(W, E), pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从文件加载Cookie按钮</span></span><br><span class="line">        ttk.Button(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;从文件加载&quot;</span>, command=<span class="variable language_">self</span>.load_cookie).grid(row=<span class="number">5</span>, column=<span class="number">2</span>, padx=(<span class="number">5</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 输出文件路径</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;输出文件:&quot;</span>).grid(row=<span class="number">6</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.output_entry = ttk.Entry(<span class="variable language_">self</span>.main_frame, width=<span class="number">50</span>)</span><br><span class="line">        default_output = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.output_file)</span><br><span class="line">        <span class="variable language_">self</span>.output_entry.insert(<span class="number">0</span>, default_output)</span><br><span class="line">        <span class="variable language_">self</span>.output_entry.grid(row=<span class="number">7</span>, column=<span class="number">0</span>, sticky=(W, E), pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 浏览按钮</span></span><br><span class="line">        ttk.Button(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;浏览...&quot;</span>, command=<span class="variable language_">self</span>.browse_output).grid(row=<span class="number">7</span>, column=<span class="number">1</span>, sticky=W, padx=(<span class="number">5</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 操作按钮</span></span><br><span class="line">        <span class="variable language_">self</span>.start_button = ttk.Button(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;开始搜索&quot;</span>, command=<span class="variable language_">self</span>.start_search)</span><br><span class="line">        <span class="variable language_">self</span>.start_button.grid(row=<span class="number">8</span>, column=<span class="number">0</span>, pady=(<span class="number">10</span>, <span class="number">0</span>), sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.stop_button = ttk.Button(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;停止搜索&quot;</span>, command=<span class="variable language_">self</span>.stop_search, state=DISABLED)</span><br><span class="line">        <span class="variable language_">self</span>.stop_button.grid(row=<span class="number">8</span>, column=<span class="number">1</span>, pady=(<span class="number">10</span>, <span class="number">0</span>), sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清空按钮</span></span><br><span class="line">        <span class="variable language_">self</span>.clear_button = ttk.Button(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;清空结果&quot;</span>, command=<span class="variable language_">self</span>.clear_results)</span><br><span class="line">        <span class="variable language_">self</span>.clear_button.grid(row=<span class="number">8</span>, column=<span class="number">2</span>, pady=(<span class="number">10</span>, <span class="number">0</span>), sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 统计信息</span></span><br><span class="line">        <span class="variable language_">self</span>.stats_label = ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;就绪&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.stats_label.grid(row=<span class="number">8</span>, column=<span class="number">3</span>, pady=(<span class="number">10</span>, <span class="number">0</span>), sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 进度条</span></span><br><span class="line">        <span class="variable language_">self</span>.progress_var = DoubleVar()</span><br><span class="line">        <span class="variable language_">self</span>.progress_bar = ttk.Progressbar(</span><br><span class="line">            <span class="variable language_">self</span>.main_frame, </span><br><span class="line">            variable=<span class="variable language_">self</span>.progress_var, </span><br><span class="line">            maximum=<span class="number">100</span>,</span><br><span class="line">            mode=<span class="string">&#x27;determinate&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.progress_bar.grid(row=<span class="number">9</span>, column=<span class="number">0</span>, columnspan=<span class="number">4</span>, sticky=(W, E), pady=(<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 日志区域</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;日志输出:&quot;</span>).grid(row=<span class="number">10</span>, column=<span class="number">0</span>, sticky=W, pady=(<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line">        <span class="variable language_">self</span>.log_text = Text(<span class="variable language_">self</span>.main_frame, wrap=WORD, height=<span class="number">20</span>)</span><br><span class="line">        <span class="variable language_">self</span>.log_text.grid(row=<span class="number">11</span>, column=<span class="number">0</span>, columnspan=<span class="number">4</span>, sticky=(W, E, N, S), pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 滚动条</span></span><br><span class="line">        scrollbar = ttk.Scrollbar(<span class="variable language_">self</span>.main_frame, orient=VERTICAL, command=<span class="variable language_">self</span>.log_text.yview)</span><br><span class="line">        scrollbar.grid(row=<span class="number">11</span>, column=<span class="number">4</span>, sticky=(N, S))</span><br><span class="line">        <span class="variable language_">self</span>.log_text[<span class="string">&#x27;yscrollcommand&#x27;</span>] = scrollbar.<span class="built_in">set</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 加载保存的Cookie和已有BV号</span></span><br><span class="line">        <span class="variable language_">self</span>.load_cookie()</span><br><span class="line">        <span class="variable language_">self</span>.load_existing_bvids()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 配置网格布局权重</span></span><br><span class="line">        <span class="variable language_">self</span>.main_frame.columnconfigure(<span class="number">0</span>, weight=<span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.main_frame.rowconfigure(<span class="number">11</span>, weight=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">browse_output</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;选择输出文件路径&quot;&quot;&quot;</span></span><br><span class="line">        path = filedialog.asksaveasfilename(</span><br><span class="line">            title=<span class="string">&quot;保存BV号列表&quot;</span>,</span><br><span class="line">            defaultextension=<span class="string">&quot;.txt&quot;</span>,</span><br><span class="line">            filetypes=[(<span class="string">&quot;文本文件&quot;</span>, <span class="string">&quot;*.txt&quot;</span>), (<span class="string">&quot;所有文件&quot;</span>, <span class="string">&quot;*.*&quot;</span>)],</span><br><span class="line">            initialdir=<span class="variable language_">self</span>.script_dir,</span><br><span class="line">            initialfile=<span class="variable language_">self</span>.output_file</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> path:</span><br><span class="line">            <span class="variable language_">self</span>.output_entry.delete(<span class="number">0</span>, END)</span><br><span class="line">            <span class="variable language_">self</span>.output_entry.insert(<span class="number">0</span>, path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log</span>(<span class="params">self, message: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加日志到日志区域&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> message <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        timestamp = datetime.now().strftime(<span class="string">&quot;%H:%M:%S&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.log_text.insert(END, <span class="string">f&quot;[<span class="subst">&#123;timestamp&#125;</span>] <span class="subst">&#123;message&#125;</span>\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.log_text.see(END)</span><br><span class="line">        <span class="variable language_">self</span>.root.update()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_progress</span>(<span class="params">self, value: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新进度条&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.progress_var.<span class="built_in">set</span>(value)</span><br><span class="line">        <span class="variable language_">self</span>.root.update()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_stats</span>(<span class="params">self, message: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新统计信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.stats_label.config(text=message)</span><br><span class="line">        <span class="variable language_">self</span>.root.update()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_cookie</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从文件加载保存的Cookie&quot;&quot;&quot;</span></span><br><span class="line">        cookie_path = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.cookie_file)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(cookie_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(cookie_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    cookie = f.read().strip()</span><br><span class="line">                    <span class="variable language_">self</span>.cookie_entry.delete(<span class="number">0</span>, END)</span><br><span class="line">                    <span class="variable language_">self</span>.cookie_entry.insert(<span class="number">0</span>, cookie)</span><br><span class="line">                    <span class="variable language_">self</span>.log(<span class="string">&quot;已从文件加载Cookie&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;加载Cookie文件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_existing_bvids</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载已存在的BV号&quot;&quot;&quot;</span></span><br><span class="line">        output_path = <span class="variable language_">self</span>.output_entry.get().strip()</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(output_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                        bvid = line.strip()</span><br><span class="line">                        <span class="keyword">if</span> bvid <span class="keyword">and</span> bvid.startswith(<span class="string">&quot;BV&quot;</span>):</span><br><span class="line">                            <span class="variable language_">self</span>.existing_bvids.add(bvid)</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;已加载 <span class="subst">&#123;<span class="built_in">len</span>(self.existing_bvids)&#125;</span> 个已有BV号&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;加载已有BV号失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_cookie</span>(<span class="params">self, cookie: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存Cookie到文件&quot;&quot;&quot;</span></span><br><span class="line">        cookie_path = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.cookie_file)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(cookie_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(cookie)</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">&quot;Cookie已保存&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">f&quot;保存Cookie失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_bvid_list</span>(<span class="params">self, bvids: <span class="type">List</span>[<span class="built_in">str</span>], file_path: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存BV号列表到文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 确保目录存在</span></span><br><span class="line">            os.makedirs(os.path.dirname(file_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line">            </span><br><span class="line">            mode = <span class="string">&quot;a&quot;</span> <span class="keyword">if</span> <span class="variable language_">self</span>.append_mode_var.get() <span class="keyword">else</span> <span class="string">&quot;w&quot;</span></span><br><span class="line">            new_bvids = []</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, mode, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">if</span> mode == <span class="string">&quot;w&quot;</span>:</span><br><span class="line">                    <span class="variable language_">self</span>.existing_bvids.clear()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> bvid <span class="keyword">in</span> bvids:</span><br><span class="line">                    <span class="keyword">if</span> bvid <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.existing_bvids:</span><br><span class="line">                        f.write(<span class="string">f&quot;<span class="subst">&#123;bvid&#125;</span>\n&quot;</span>)</span><br><span class="line">                        <span class="variable language_">self</span>.existing_bvids.add(bvid)</span><br><span class="line">                        new_bvids.append(bvid)</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">f&quot;已成功保存 <span class="subst">&#123;<span class="built_in">len</span>(new_bvids)&#125;</span> 个新BV号到 <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(bvids) - <span class="built_in">len</span>(new_bvids) &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;跳过 <span class="subst">&#123;<span class="built_in">len</span>(bvids) - <span class="built_in">len</span>(new_bvids)&#125;</span> 个重复BV号&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">f&quot;保存BV号列表失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear_results</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清空结果&quot;&quot;&quot;</span></span><br><span class="line">        output_path = <span class="variable language_">self</span>.output_entry.get().strip()</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(output_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.remove(output_path)</span><br><span class="line">                <span class="variable language_">self</span>.existing_bvids.clear()</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">&quot;已清空结果文件&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.update_stats(<span class="string">&quot;已清空结果&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;清空结果文件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">&quot;结果文件不存在&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_search</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;开始搜索视频&quot;&quot;&quot;</span></span><br><span class="line">        keyword = <span class="variable language_">self</span>.keyword_entry.get().strip()</span><br><span class="line">        count = <span class="variable language_">self</span>.count_entry.get().strip()</span><br><span class="line">        cookie = <span class="variable language_">self</span>.cookie_entry.get().strip()</span><br><span class="line">        output_path = <span class="variable language_">self</span>.output_entry.get().strip()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> keyword:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;请输入搜索关键词&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> count.isdigit() <span class="keyword">or</span> <span class="built_in">int</span>(count) &lt;= <span class="number">0</span>:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;请输入有效的获取数量&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> output_path:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;请选择输出文件路径&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存Cookie</span></span><br><span class="line">        <span class="keyword">if</span> cookie:</span><br><span class="line">            <span class="variable language_">self</span>.save_cookie(cookie)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化爬虫</span></span><br><span class="line">        <span class="variable language_">self</span>.crawler = BiliBiliVideoCrawler(cookie=cookie <span class="keyword">if</span> cookie <span class="keyword">else</span> <span class="literal">None</span>, log_callback=<span class="variable language_">self</span>.log)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 禁用开始按钮，启用停止按钮</span></span><br><span class="line">        <span class="variable language_">self</span>.start_button.config(state=DISABLED)</span><br><span class="line">        <span class="variable language_">self</span>.stop_button.config(state=NORMAL)</span><br><span class="line">        <span class="variable language_">self</span>.clear_button.config(state=DISABLED)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重置进度条</span></span><br><span class="line">        <span class="variable language_">self</span>.progress_var.<span class="built_in">set</span>(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清空日志</span></span><br><span class="line">        <span class="variable language_">self</span>.log_text.delete(<span class="number">1.0</span>, END)</span><br><span class="line">        <span class="variable language_">self</span>.log(<span class="string">f&quot;开始搜索关键词 &#x27;<span class="subst">&#123;keyword&#125;</span>&#x27; 的视频...&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.update_stats(<span class="string">&quot;搜索中...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 在新线程中运行搜索</span></span><br><span class="line">        <span class="keyword">import</span> threading</span><br><span class="line">        thread = threading.Thread(</span><br><span class="line">            target=<span class="variable language_">self</span>._run_search,</span><br><span class="line">            args=(keyword, <span class="built_in">int</span>(count), output_path),</span><br><span class="line">            daemon=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_run_search</span>(<span class="params">self, keyword: <span class="built_in">str</span>, max_count: <span class="built_in">int</span>, output_path: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行搜索（在线程中执行）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 搜索视频</span></span><br><span class="line">            bvids = <span class="variable language_">self</span>.crawler.search_videos(keyword, max_count)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> bvids:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">&quot;没有获取到任何视频BV号&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 保存结果</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.save_bvid_list(bvids, output_path):</span><br><span class="line">                <span class="variable language_">self</span>.update_stats(<span class="string">f&quot;完成: 总BV号数 <span class="subst">&#123;<span class="built_in">len</span>(self.existing_bvids)&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.progress_var.<span class="built_in">set</span>(<span class="number">100</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.update_stats(<span class="string">&quot;完成但保存失败&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">f&quot;搜索过程中发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.update_stats(<span class="string">&quot;错误&quot;</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># 恢复按钮状态</span></span><br><span class="line">            <span class="variable language_">self</span>.root.after(<span class="number">0</span>, <span class="keyword">lambda</span>: <span class="variable language_">self</span>.start_button.config(state=NORMAL))</span><br><span class="line">            <span class="variable language_">self</span>.root.after(<span class="number">0</span>, <span class="keyword">lambda</span>: <span class="variable language_">self</span>.stop_button.config(state=DISABLED))</span><br><span class="line">            <span class="variable language_">self</span>.root.after(<span class="number">0</span>, <span class="keyword">lambda</span>: <span class="variable language_">self</span>.clear_button.config(state=NORMAL))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_search</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;停止搜索&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.crawler:</span><br><span class="line">            <span class="variable language_">self</span>.crawler.stop()</span><br><span class="line">            <span class="variable language_">self</span>.stop_button.config(state=DISABLED)</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">&quot;正在停止搜索...&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.update_stats(<span class="string">&quot;正在停止...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    root = Tk()</span><br><span class="line">    app = BiliBiliVideoSearchGUI(root)</span><br><span class="line">    root.mainloop()</span><br></pre></td></tr></table></figure>

<h3 id="2-评论爬取模块（b-ver7-py"><a href="#2-评论爬取模块（b-ver7-py" class="headerlink" title="2.评论爬取模块（b_ver7.py)"></a>2.评论爬取模块（b_ver7.py)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> fake_useragent <span class="keyword">import</span> UserAgent</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Set</span></span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> ttk, messagebox, filedialog</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommentManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.all_comments = []  <span class="comment"># 存储所有评论</span></span><br><span class="line">        <span class="variable language_">self</span>.existing_rpids = <span class="built_in">set</span>()  <span class="comment"># 用于去重的评论ID集合</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_comments</span>(<span class="params">self, new_comments: <span class="type">List</span>[<span class="type">Dict</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加新评论并返回新增数量&quot;&quot;&quot;</span></span><br><span class="line">        added_count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> comment <span class="keyword">in</span> new_comments:</span><br><span class="line">            <span class="keyword">if</span> comment[<span class="string">&#x27;rpid&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.existing_rpids:</span><br><span class="line">                <span class="variable language_">self</span>.all_comments.append(comment)</span><br><span class="line">                <span class="variable language_">self</span>.existing_rpids.add(comment[<span class="string">&#x27;rpid&#x27;</span>])</span><br><span class="line">                added_count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> added_count</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_comments</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取所有评论（已去重）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.all_comments</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清空所有评论&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.all_comments = []</span><br><span class="line">        <span class="variable language_">self</span>.existing_rpids = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BiliBiliCommentCrawler</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cookie: <span class="built_in">str</span> = <span class="literal">None</span>, log_callback=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.session = requests.Session()</span><br><span class="line">        <span class="variable language_">self</span>.ua = UserAgent()</span><br><span class="line">        <span class="variable language_">self</span>.cookie = cookie</span><br><span class="line">        <span class="variable language_">self</span>.log_callback = log_callback</span><br><span class="line">        <span class="variable language_">self</span>._update_headers()</span><br><span class="line">        <span class="variable language_">self</span>.running = <span class="literal">True</span></span><br><span class="line">        <span class="variable language_">self</span>.comment_manager = CommentManager()</span><br><span class="line">        <span class="variable language_">self</span>.max_sub_comments = <span class="number">20</span>  <span class="comment"># 默认每个一级评论最多爬取的二级评论数</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_max_sub_comments</span>(<span class="params">self, max_sub_comments: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置每个一级评论下最多爬取的二级评论数量&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.max_sub_comments = <span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">min</span>(max_sub_comments, <span class="number">100</span>))  <span class="comment"># 限制在0-100之间</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_log</span>(<span class="params">self, message: <span class="built_in">str</span> = <span class="literal">None</span>, update_counts=<span class="literal">False</span>, primary=<span class="number">0</span>, secondary=<span class="number">0</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录日志&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> message <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> update_counts:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> update_counts:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.log_callback:</span><br><span class="line">                <span class="variable language_">self</span>.log_callback(update_counts=<span class="literal">True</span>, primary=primary, secondary=secondary)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        timestamp = datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">        log_message = <span class="string">f&quot;[<span class="subst">&#123;timestamp&#125;</span>] <span class="subst">&#123;message&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.log_callback:</span><br><span class="line">            <span class="variable language_">self</span>.log_callback(log_message)</span><br><span class="line">        <span class="built_in">print</span>(log_message)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_update_headers</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新请求头&quot;&quot;&quot;</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;User-Agent&#x27;</span>: <span class="variable language_">self</span>.ua.random,</span><br><span class="line">            <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;https://www.bilibili.com/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Origin&#x27;</span>: <span class="string">&#x27;https://www.bilibili.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json, text/plain, */*&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9,en;q=0.8&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.cookie:</span><br><span class="line">            headers[<span class="string">&#x27;Cookie&#x27;</span>] = <span class="variable language_">self</span>.cookie</span><br><span class="line">        <span class="variable language_">self</span>.session.headers.update(headers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;停止爬取&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.running = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>._log(<span class="string">&quot;正在停止爬取...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_video_aid</span>(<span class="params">self, bvid: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;将BV号转换为aid&quot;&quot;&quot;</span></span><br><span class="line">        url = <span class="string">f&quot;https://api.bilibili.com/x/web-interface/view?bvid=<span class="subst">&#123;bvid&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>._update_headers()</span><br><span class="line">            <span class="variable language_">self</span>._log(<span class="string">f&quot;正在获取视频aid (BV号: <span class="subst">&#123;bvid&#125;</span>)...&quot;</span>)</span><br><span class="line">            resp = <span class="variable language_">self</span>.session.get(url)</span><br><span class="line">            data = resp.json()</span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&#x27;code&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">                <span class="variable language_">self</span>._log(<span class="string">f&quot;成功获取视频aid: <span class="subst">&#123;data[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;aid&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> data[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;aid&#x27;</span>]</span><br><span class="line">            <span class="variable language_">self</span>._log(<span class="string">f&quot;获取aid失败: <span class="subst">&#123;data[<span class="string">&#x27;message&#x27;</span>]&#125;</span> (code: <span class="subst">&#123;data[<span class="string">&#x27;code&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>._log(<span class="string">f&quot;获取aid发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_comments</span>(<span class="params">self, oid: <span class="built_in">int</span>, max_count: <span class="built_in">int</span> = <span class="number">1000</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取B站视频评论（一级评论数量严格匹配输入值）&quot;&quot;&quot;</span></span><br><span class="line">        page = <span class="number">1</span></span><br><span class="line">        primary_count = <span class="number">0</span>  <span class="comment"># 只统计一级评论</span></span><br><span class="line">        secondary_count = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> primary_count &lt; max_count <span class="keyword">and</span> <span class="variable language_">self</span>.running:</span><br><span class="line">            <span class="comment"># 获取一级评论</span></span><br><span class="line">            url = <span class="string">f&quot;https://api.bilibili.com/x/v2/reply/main?jsonp=jsonp&amp;next=<span class="subst">&#123;page&#125;</span>&amp;type=1&amp;oid=<span class="subst">&#123;oid&#125;</span>&amp;mode=3&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>._update_headers()</span><br><span class="line">                <span class="variable language_">self</span>._log(<span class="string">f&quot;正在获取第 <span class="subst">&#123;page&#125;</span> 页评论...&quot;</span>)</span><br><span class="line">                resp = <span class="variable language_">self</span>.session.get(url)</span><br><span class="line">                data = resp.json()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> data[<span class="string">&#x27;code&#x27;</span>] == -<span class="number">412</span>:</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">&quot;触发风控，等待30秒后重试...&quot;</span>)</span><br><span class="line">                    time.sleep(<span class="number">30</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> data[<span class="string">&#x27;code&#x27;</span>] != <span class="number">0</span>:</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">f&quot;获取评论失败: <span class="subst">&#123;data[<span class="string">&#x27;message&#x27;</span>]&#125;</span> (code: <span class="subst">&#123;data[<span class="string">&#x27;code&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> data[<span class="string">&#x27;code&#x27;</span>] == -<span class="number">352</span>:</span><br><span class="line">                        <span class="variable language_">self</span>._log(<span class="string">&quot;建议：1.检查Cookie是否有效 2.增加请求间隔 3.使用代理IP&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                replies = data[<span class="string">&#x27;data&#x27;</span>].get(<span class="string">&#x27;replies&#x27;</span>, [])</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> replies:</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">&quot;没有更多评论了&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                new_comments = []</span><br><span class="line">                <span class="keyword">for</span> reply <span class="keyword">in</span> replies:</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.running <span class="keyword">or</span> primary_count &gt;= max_count:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 处理一级评论</span></span><br><span class="line">                    comment = <span class="variable language_">self</span>._parse_comment(reply)</span><br><span class="line">                    new_comments.append(comment)</span><br><span class="line">                    primary_count += <span class="number">1</span></span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">f&quot;获取评论: <span class="subst">&#123;comment[<span class="string">&#x27;user&#x27;</span>][<span class="string">&#x27;uname&#x27;</span>]&#125;</span>: <span class="subst">&#123;comment[<span class="string">&#x27;content&#x27;</span>][:<span class="number">30</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">&quot;&quot;</span>, update_counts=<span class="literal">True</span>, primary=primary_count, secondary=secondary_count)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 获取二级评论（不影响主计数）</span></span><br><span class="line">                    <span class="keyword">if</span> reply[<span class="string">&#x27;rcount&#x27;</span>] &gt; <span class="number">0</span> <span class="keyword">and</span> <span class="variable language_">self</span>.max_sub_comments &gt; <span class="number">0</span>:</span><br><span class="line">                        sub_comments = <span class="variable language_">self</span>._get_sub_comments(oid, reply[<span class="string">&#x27;rpid&#x27;</span>], <span class="built_in">min</span>(reply[<span class="string">&#x27;rcount&#x27;</span>], <span class="variable language_">self</span>.max_sub_comments))</span><br><span class="line">                        <span class="keyword">for</span> sub <span class="keyword">in</span> sub_comments:</span><br><span class="line">                            secondary_count += <span class="number">1</span></span><br><span class="line">                            <span class="variable language_">self</span>._log(<span class="string">&quot;&quot;</span>, update_counts=<span class="literal">True</span>, primary=primary_count, secondary=secondary_count)</span><br><span class="line">                        new_comments.extend(sub_comments)</span><br><span class="line">                        time.sleep(<span class="number">1</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 添加新评论</span></span><br><span class="line">                added = <span class="variable language_">self</span>.comment_manager.add_comments(new_comments)</span><br><span class="line">                <span class="variable language_">self</span>._log(<span class="string">f&quot;当前已获取 <span class="subst">&#123;primary_count&#125;</span>/<span class="subst">&#123;max_count&#125;</span> 条一级评论（本页新增 <span class="subst">&#123;added&#125;</span> 条）...&quot;</span>)</span><br><span class="line">                page += <span class="number">1</span></span><br><span class="line">                time.sleep(<span class="number">2</span>)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>._log(<span class="string">f&quot;发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                time.sleep(<span class="number">5</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> primary_count  <span class="comment"># 返回实际获取的一级评论数量</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_sub_comments</span>(<span class="params">self, oid: <span class="built_in">int</span>, root_rpid: <span class="built_in">int</span>, max_count: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取二级评论（限制每个一级评论最多获取指定数量的二级评论）&quot;&quot;&quot;</span></span><br><span class="line">        sub_comments = []</span><br><span class="line">        page = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(sub_comments) &lt; max_count <span class="keyword">and</span> <span class="variable language_">self</span>.running:</span><br><span class="line">            url = <span class="string">f&quot;https://api.bilibili.com/x/v2/reply/reply?jsonp=jsonp&amp;pn=<span class="subst">&#123;page&#125;</span>&amp;type=1&amp;oid=<span class="subst">&#123;oid&#125;</span>&amp;root=<span class="subst">&#123;root_rpid&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>._update_headers()</span><br><span class="line">                <span class="variable language_">self</span>._log(<span class="string">f&quot;正在获取第 <span class="subst">&#123;page&#125;</span> 页二级评论 (root: <span class="subst">&#123;root_rpid&#125;</span>)...&quot;</span>)</span><br><span class="line">                resp = <span class="variable language_">self</span>.session.get(url)</span><br><span class="line">                data = resp.json()</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> data[<span class="string">&#x27;code&#x27;</span>] == -<span class="number">412</span>:</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">&quot;触发风控，等待15秒后重试...&quot;</span>)</span><br><span class="line">                    time.sleep(<span class="number">15</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> data[<span class="string">&#x27;code&#x27;</span>] != <span class="number">0</span>:</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">f&quot;获取二级评论失败: <span class="subst">&#123;data[<span class="string">&#x27;message&#x27;</span>]&#125;</span> (code: <span class="subst">&#123;data[<span class="string">&#x27;code&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                replies = data[<span class="string">&#x27;data&#x27;</span>].get(<span class="string">&#x27;replies&#x27;</span>, [])</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> replies:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> reply <span class="keyword">in</span> replies:</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.running <span class="keyword">or</span> <span class="built_in">len</span>(sub_comments) &gt;= max_count:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    </span><br><span class="line">                    comment = <span class="variable language_">self</span>._parse_comment(reply)</span><br><span class="line">                    sub_comments.append(comment)</span><br><span class="line">                    <span class="variable language_">self</span>._log(<span class="string">f&quot;获取二级评论: <span class="subst">&#123;comment[<span class="string">&#x27;user&#x27;</span>][<span class="string">&#x27;uname&#x27;</span>]&#125;</span>: <span class="subst">&#123;comment[<span class="string">&#x27;content&#x27;</span>][:<span class="number">30</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                page += <span class="number">1</span></span><br><span class="line">                time.sleep(<span class="number">1.5</span>)</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>._log(<span class="string">f&quot;获取二级评论发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                time.sleep(<span class="number">3</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> sub_comments</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_comment</span>(<span class="params">self, comment: <span class="type">Dict</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析评论数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;rpid&#x27;</span>: comment[<span class="string">&#x27;rpid&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;uid&#x27;</span>: comment[<span class="string">&#x27;member&#x27;</span>][<span class="string">&#x27;mid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;uname&#x27;</span>: comment[<span class="string">&#x27;member&#x27;</span>][<span class="string">&#x27;uname&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;avatar&#x27;</span>: comment[<span class="string">&#x27;member&#x27;</span>][<span class="string">&#x27;avatar&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;content&#x27;</span>: comment[<span class="string">&#x27;content&#x27;</span>][<span class="string">&#x27;message&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;like&#x27;</span>: comment[<span class="string">&#x27;like&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;ctime&#x27;</span>: time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, time.localtime(comment[<span class="string">&#x27;ctime&#x27;</span>])),</span><br><span class="line">            <span class="string">&#x27;count&#x27;</span>: comment[<span class="string">&#x27;count&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;root&#x27;</span>: comment.get(<span class="string">&#x27;root&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;parent&#x27;</span>: comment.get(<span class="string">&#x27;parent&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;level&#x27;</span>: <span class="string">&#x27;二级&#x27;</span> <span class="keyword">if</span> comment.get(<span class="string">&#x27;parent&#x27;</span>, <span class="number">0</span>) != <span class="number">0</span> <span class="keyword">else</span> <span class="string">&#x27;一级&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BiliBiliCommentGUI</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="variable language_">self</span>.root = root</span><br><span class="line">        <span class="variable language_">self</span>.root.title(<span class="string">&quot;B站评论爬取工具&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.root.geometry(<span class="string">&quot;900x750&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cookie_file = <span class="string">&quot;bilibili_cookie.txt&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.combined_file = <span class="string">&quot;bilibili_comments_combined.csv&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.bvid_list_file = <span class="string">&quot;bvid_list.txt&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.crawler = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.current_bvid_index = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.bvid_list = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取脚本所在目录</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">getattr</span>(sys, <span class="string">&#x27;frozen&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">            <span class="variable language_">self</span>.script_dir = os.path.dirname(sys.executable)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.script_dir = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建主框架</span></span><br><span class="line">        <span class="variable language_">self</span>.main_frame = ttk.Frame(root, padding=<span class="string">&quot;10&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.main_frame.pack(fill=BOTH, expand=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 模式选择</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;工作模式:&quot;</span>).grid(row=<span class="number">0</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.mode_var = StringVar(value=<span class="string">&quot;multi&quot;</span>)  <span class="comment"># 默认改为多视频模式</span></span><br><span class="line">        ttk.Radiobutton(</span><br><span class="line">            <span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;单视频模式&quot;</span>, </span><br><span class="line">            variable=<span class="variable language_">self</span>.mode_var, value=<span class="string">&quot;single&quot;</span>,</span><br><span class="line">            command=<span class="variable language_">self</span>.toggle_mode</span><br><span class="line">        ).grid(row=<span class="number">1</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        ttk.Radiobutton(</span><br><span class="line">            <span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;多视频合并模式&quot;</span>, </span><br><span class="line">            variable=<span class="variable language_">self</span>.mode_var, value=<span class="string">&quot;multi&quot;</span>,</span><br><span class="line">            command=<span class="variable language_">self</span>.toggle_mode</span><br><span class="line">        ).grid(row=<span class="number">1</span>, column=<span class="number">1</span>, sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cookie部分</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;B站Cookie:&quot;</span>).grid(row=<span class="number">2</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.cookie_entry = ttk.Entry(<span class="variable language_">self</span>.main_frame, width=<span class="number">80</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cookie_entry.grid(row=<span class="number">3</span>, column=<span class="number">0</span>, columnspan=<span class="number">2</span>, sticky=(W, E), pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从文件加载Cookie按钮</span></span><br><span class="line">        ttk.Button(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;从文件加载&quot;</span>, command=<span class="variable language_">self</span>.load_cookie).grid(row=<span class="number">3</span>, column=<span class="number">2</span>, padx=(<span class="number">5</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># BV号部分</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;视频BV号:&quot;</span>).grid(row=<span class="number">4</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.bvid_entry = ttk.Entry(<span class="variable language_">self</span>.main_frame, width=<span class="number">20</span>)</span><br><span class="line">        <span class="variable language_">self</span>.bvid_entry.grid(row=<span class="number">5</span>, column=<span class="number">0</span>, sticky=W, pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从文件加载BV号按钮</span></span><br><span class="line">        ttk.Button(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;从TXT加载&quot;</span>, command=<span class="variable language_">self</span>.load_bvid_list).grid(row=<span class="number">5</span>, column=<span class="number">1</span>, sticky=W, padx=(<span class="number">5</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 评论数量</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;爬取数量:&quot;</span>).grid(row=<span class="number">4</span>, column=<span class="number">2</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.count_entry = ttk.Entry(<span class="variable language_">self</span>.main_frame, width=<span class="number">10</span>)</span><br><span class="line">        <span class="variable language_">self</span>.count_entry.insert(<span class="number">0</span>, <span class="string">&quot;500&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.count_entry.grid(row=<span class="number">5</span>, column=<span class="number">2</span>, sticky=W, pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 二级评论数量设置</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;每个一级评论下爬取的二级评论数量:&quot;</span>).grid(row=<span class="number">6</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.sub_comments_entry = ttk.Entry(<span class="variable language_">self</span>.main_frame, width=<span class="number">10</span>)</span><br><span class="line">        <span class="variable language_">self</span>.sub_comments_entry.insert(<span class="number">0</span>, <span class="string">&quot;20&quot;</span>)  <span class="comment"># 默认20条</span></span><br><span class="line">        <span class="variable language_">self</span>.sub_comments_entry.grid(row=<span class="number">6</span>, column=<span class="number">1</span>, sticky=W, pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 多视频模式控制</span></span><br><span class="line">        <span class="variable language_">self</span>.multi_control_frame = ttk.Frame(<span class="variable language_">self</span>.main_frame)</span><br><span class="line">        ttk.Button(</span><br><span class="line">            <span class="variable language_">self</span>.multi_control_frame, text=<span class="string">&quot;清空合并数据&quot;</span>, </span><br><span class="line">            command=<span class="variable language_">self</span>.clear_combined_data</span><br><span class="line">        ).pack(side=LEFT, padx=(<span class="number">0</span>, <span class="number">5</span>))</span><br><span class="line">        ttk.Button(</span><br><span class="line">            <span class="variable language_">self</span>.multi_control_frame, text=<span class="string">&quot;导出合并数据&quot;</span>, </span><br><span class="line">            command=<span class="variable language_">self</span>.export_combined_data</span><br><span class="line">        ).pack(side=LEFT)</span><br><span class="line">        <span class="variable language_">self</span>.multi_control_frame.grid(row=<span class="number">6</span>, column=<span class="number">2</span>, sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 视频队列信息</span></span><br><span class="line">        <span class="variable language_">self</span>.queue_frame = ttk.Frame(<span class="variable language_">self</span>.main_frame)</span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.queue_frame, text=<span class="string">&quot;视频队列:&quot;</span>).pack(side=LEFT)</span><br><span class="line">        <span class="variable language_">self</span>.queue_info_var = StringVar(value=<span class="string">&quot;0个视频待爬取&quot;</span>)</span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.queue_frame, textvariable=<span class="variable language_">self</span>.queue_info_var).pack(side=LEFT, padx=(<span class="number">5</span>, <span class="number">0</span>))</span><br><span class="line">        <span class="variable language_">self</span>.queue_frame.grid(row=<span class="number">7</span>, column=<span class="number">0</span>, columnspan=<span class="number">4</span>, sticky=W, pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存位置选项</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;保存位置:&quot;</span>).grid(row=<span class="number">8</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        <span class="variable language_">self</span>.save_location_var = StringVar(value=<span class="string">&quot;auto&quot;</span>)</span><br><span class="line">        ttk.Radiobutton(</span><br><span class="line">            <span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;自动保存到脚本目录&quot;</span>, </span><br><span class="line">            variable=<span class="variable language_">self</span>.save_location_var, value=<span class="string">&quot;auto&quot;</span></span><br><span class="line">        ).grid(row=<span class="number">9</span>, column=<span class="number">0</span>, sticky=W)</span><br><span class="line">        ttk.Radiobutton(</span><br><span class="line">            <span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;自定义保存位置&quot;</span>, </span><br><span class="line">            variable=<span class="variable language_">self</span>.save_location_var, value=<span class="string">&quot;custom&quot;</span>,</span><br><span class="line">            command=<span class="variable language_">self</span>.toggle_save_location</span><br><span class="line">        ).grid(row=<span class="number">9</span>, column=<span class="number">1</span>, sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 自定义路径输入框和浏览按钮</span></span><br><span class="line">        <span class="variable language_">self</span>.path_frame = ttk.Frame(<span class="variable language_">self</span>.main_frame)</span><br><span class="line">        <span class="variable language_">self</span>.path_entry = ttk.Entry(<span class="variable language_">self</span>.path_frame, width=<span class="number">50</span>)</span><br><span class="line">        <span class="variable language_">self</span>.path_entry.pack(side=LEFT, fill=X, expand=<span class="literal">True</span>)</span><br><span class="line">        ttk.Button(<span class="variable language_">self</span>.path_frame, text=<span class="string">&quot;浏览...&quot;</span>, command=<span class="variable language_">self</span>.browse_path).pack(side=LEFT, padx=(<span class="number">5</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 操作按钮</span></span><br><span class="line">        <span class="variable language_">self</span>.start_button = ttk.Button(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;开始爬取&quot;</span>, command=<span class="variable language_">self</span>.start_crawling)</span><br><span class="line">        <span class="variable language_">self</span>.start_button.grid(row=<span class="number">10</span>, column=<span class="number">0</span>, pady=(<span class="number">10</span>, <span class="number">0</span>), sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.stop_button = ttk.Button(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;停止爬取&quot;</span>, command=<span class="variable language_">self</span>.stop_crawling, state=DISABLED)</span><br><span class="line">        <span class="variable language_">self</span>.stop_button.grid(row=<span class="number">10</span>, column=<span class="number">1</span>, pady=(<span class="number">10</span>, <span class="number">0</span>), sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 统计信息</span></span><br><span class="line">        <span class="variable language_">self</span>.stats_label = ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;就绪&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.stats_label.grid(row=<span class="number">10</span>, column=<span class="number">2</span>, pady=(<span class="number">10</span>, <span class="number">0</span>), sticky=W)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 进度条框架</span></span><br><span class="line">        <span class="variable language_">self</span>.progress_frame = ttk.Frame(<span class="variable language_">self</span>.main_frame)</span><br><span class="line">        <span class="variable language_">self</span>.progress_frame.grid(row=<span class="number">11</span>, column=<span class="number">0</span>, columnspan=<span class="number">4</span>, sticky=(W, E), pady=(<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 一级评论计数器</span></span><br><span class="line">        <span class="variable language_">self</span>.primary_count_var = StringVar(value=<span class="string">&quot;一级评论: 0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.primary_count_label = ttk.Label(<span class="variable language_">self</span>.progress_frame, textvariable=<span class="variable language_">self</span>.primary_count_var)</span><br><span class="line">        <span class="variable language_">self</span>.primary_count_label.pack(side=LEFT, padx=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 二级评论计数器</span></span><br><span class="line">        <span class="variable language_">self</span>.secondary_count_var = StringVar(value=<span class="string">&quot;二级评论: 0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.secondary_count_label = ttk.Label(<span class="variable language_">self</span>.progress_frame, textvariable=<span class="variable language_">self</span>.secondary_count_var)</span><br><span class="line">        <span class="variable language_">self</span>.secondary_count_label.pack(side=LEFT)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 视频进度计数器</span></span><br><span class="line">        <span class="variable language_">self</span>.video_progress_var = StringVar(value=<span class="string">&quot;视频进度: 0/0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.video_progress_label = ttk.Label(<span class="variable language_">self</span>.progress_frame, textvariable=<span class="variable language_">self</span>.video_progress_var)</span><br><span class="line">        <span class="variable language_">self</span>.video_progress_label.pack(side=LEFT, padx=(<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 进度条</span></span><br><span class="line">        <span class="variable language_">self</span>.progress_var = DoubleVar()</span><br><span class="line">        <span class="variable language_">self</span>.progress_bar = ttk.Progressbar(</span><br><span class="line">            <span class="variable language_">self</span>.main_frame, </span><br><span class="line">            variable=<span class="variable language_">self</span>.progress_var, </span><br><span class="line">            maximum=<span class="number">100</span>,</span><br><span class="line">            mode=<span class="string">&#x27;determinate&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.progress_bar.grid(row=<span class="number">12</span>, column=<span class="number">0</span>, columnspan=<span class="number">4</span>, sticky=(W, E), pady=(<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 日志区域</span></span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;日志输出:&quot;</span>).grid(row=<span class="number">13</span>, column=<span class="number">0</span>, sticky=W, pady=(<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line">        <span class="variable language_">self</span>.log_text = Text(<span class="variable language_">self</span>.main_frame, wrap=WORD, height=<span class="number">20</span>)</span><br><span class="line">        <span class="variable language_">self</span>.log_text.grid(row=<span class="number">14</span>, column=<span class="number">0</span>, columnspan=<span class="number">4</span>, sticky=(W, E, N, S), pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 滚动条</span></span><br><span class="line">        scrollbar = ttk.Scrollbar(<span class="variable language_">self</span>.main_frame, orient=VERTICAL, command=<span class="variable language_">self</span>.log_text.yview)</span><br><span class="line">        scrollbar.grid(row=<span class="number">14</span>, column=<span class="number">4</span>, sticky=(N, S))</span><br><span class="line">        <span class="variable language_">self</span>.log_text[<span class="string">&#x27;yscrollcommand&#x27;</span>] = scrollbar.<span class="built_in">set</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 加载保存的Cookie和BV号列表</span></span><br><span class="line">        <span class="variable language_">self</span>.load_cookie()</span><br><span class="line">        <span class="variable language_">self</span>.load_bvid_list(show_message=<span class="literal">False</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 配置网格布局权重</span></span><br><span class="line">        <span class="variable language_">self</span>.main_frame.columnconfigure(<span class="number">0</span>, weight=<span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">self</span>.main_frame.rowconfigure(<span class="number">14</span>, weight=<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">toggle_mode</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;切换单视频/多视频模式&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.mode_var.get() == <span class="string">&quot;multi&quot;</span>:</span><br><span class="line">            <span class="variable language_">self</span>.multi_control_frame.grid()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.multi_control_frame.grid_remove()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">toggle_save_location</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;切换保存位置选项&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.save_location_var.get() == <span class="string">&quot;custom&quot;</span>:</span><br><span class="line">            <span class="variable language_">self</span>.path_frame.grid(row=<span class="number">9</span>, column=<span class="number">2</span>, sticky=(W, E), pady=(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.path_frame.grid_forget()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">browse_path</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;选择保存路径&quot;&quot;&quot;</span></span><br><span class="line">        path = filedialog.asksaveasfilename(</span><br><span class="line">            title=<span class="string">&quot;保存评论文件&quot;</span>,</span><br><span class="line">            defaultextension=<span class="string">&quot;.csv&quot;</span>,</span><br><span class="line">            filetypes=[(<span class="string">&quot;CSV文件&quot;</span>, <span class="string">&quot;*.csv&quot;</span>), (<span class="string">&quot;所有文件&quot;</span>, <span class="string">&quot;*.*&quot;</span>)],</span><br><span class="line">            initialdir=<span class="variable language_">self</span>.script_dir,</span><br><span class="line">            initialfile=<span class="string">f&quot;bilibili_comments_<span class="subst">&#123;self.bvid_entry.get() <span class="keyword">if</span> self.bvid_entry.get() <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span>.csv&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> path:</span><br><span class="line">            <span class="variable language_">self</span>.path_entry.delete(<span class="number">0</span>, END)</span><br><span class="line">            <span class="variable language_">self</span>.path_entry.insert(<span class="number">0</span>, path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log</span>(<span class="params">self, message: <span class="built_in">str</span> = <span class="literal">None</span>, update_counts=<span class="literal">False</span>, primary=<span class="number">0</span>, secondary=<span class="number">0</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加日志到日志区域或更新计数器&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> message <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> update_counts:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> update_counts:</span><br><span class="line">            <span class="variable language_">self</span>.primary_count_var.<span class="built_in">set</span>(<span class="string">f&quot;一级评论: <span class="subst">&#123;primary&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.secondary_count_var.<span class="built_in">set</span>(<span class="string">f&quot;二级评论: <span class="subst">&#123;secondary&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 更新进度条</span></span><br><span class="line">            max_count = <span class="built_in">int</span>(<span class="variable language_">self</span>.count_entry.get()) <span class="keyword">if</span> <span class="variable language_">self</span>.count_entry.get().isdigit() <span class="keyword">else</span> <span class="number">500</span></span><br><span class="line">            <span class="keyword">if</span> max_count &gt; <span class="number">0</span>:</span><br><span class="line">                progress = <span class="built_in">min</span>(<span class="number">100</span>, (primary / max_count) * <span class="number">100</span>)  <span class="comment"># 只根据一级评论计算进度</span></span><br><span class="line">                <span class="variable language_">self</span>.progress_var.<span class="built_in">set</span>(progress)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        timestamp = datetime.now().strftime(<span class="string">&quot;%H:%M:%S&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.log_text.insert(END, <span class="string">f&quot;[<span class="subst">&#123;timestamp&#125;</span>] <span class="subst">&#123;message&#125;</span>\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.log_text.see(END)</span><br><span class="line">        <span class="variable language_">self</span>.root.update()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_stats</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新统计信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;crawler&#x27;</span>) <span class="keyword">and</span> <span class="variable language_">self</span>.crawler:</span><br><span class="line">            count = <span class="built_in">len</span>(<span class="variable language_">self</span>.crawler.comment_manager.get_all_comments())</span><br><span class="line">            <span class="variable language_">self</span>.stats_label.config(text=<span class="string">f&quot;总评论数: <span class="subst">&#123;count&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.stats_label.config(text=<span class="string">&quot;就绪&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_cookie</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从文件加载保存的Cookie&quot;&quot;&quot;</span></span><br><span class="line">        cookie_path = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.cookie_file)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(cookie_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(cookie_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    cookie = f.read().strip()</span><br><span class="line">                    <span class="variable language_">self</span>.cookie_entry.delete(<span class="number">0</span>, END)</span><br><span class="line">                    <span class="variable language_">self</span>.cookie_entry.insert(<span class="number">0</span>, cookie)</span><br><span class="line">                    <span class="variable language_">self</span>.log(<span class="string">&quot;已从文件加载Cookie&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;加载Cookie文件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_bvid_list</span>(<span class="params">self, show_message=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从TXT文件加载BV号列表&quot;&quot;&quot;</span></span><br><span class="line">        bvid_path = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.bvid_list_file)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(bvid_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(bvid_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="comment"># 读取所有行，去除空白和空行，提取有效的BV号</span></span><br><span class="line">                    lines = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines() <span class="keyword">if</span> line.strip()]</span><br><span class="line">                    <span class="variable language_">self</span>.bvid_list = []</span><br><span class="line">                    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                        <span class="comment"># 从行中提取BV号 (匹配BV开头后跟10-12位字母数字)</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="string">&quot;BV&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">                            start = line.find(<span class="string">&quot;BV&quot;</span>)</span><br><span class="line">                            bvid = line[start:start+<span class="number">12</span>]  <span class="comment"># BV号通常是12位</span></span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">len</span>(bvid) &gt;= <span class="number">10</span>:  <span class="comment"># 最小10位</span></span><br><span class="line">                                <span class="variable language_">self</span>.bvid_list.append(bvid)</span><br><span class="line">                    </span><br><span class="line">                    <span class="variable language_">self</span>.queue_info_var.<span class="built_in">set</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">len</span>(self.bvid_list)&#125;</span>个视频待爬取&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> show_message:</span><br><span class="line">                        <span class="variable language_">self</span>.log(<span class="string">f&quot;已从文件加载 <span class="subst">&#123;<span class="built_in">len</span>(self.bvid_list)&#125;</span> 个BV号&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;加载BV号列表失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.bvid_list = []</span><br><span class="line">                <span class="variable language_">self</span>.queue_info_var.<span class="built_in">set</span>(<span class="string">&quot;0个视频待爬取&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> show_message:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">&quot;没有找到BV号列表文件&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.bvid_list = []</span><br><span class="line">            <span class="variable language_">self</span>.queue_info_var.<span class="built_in">set</span>(<span class="string">&quot;0个视频待爬取&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_cookie</span>(<span class="params">self, cookie: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存Cookie到文件&quot;&quot;&quot;</span></span><br><span class="line">        cookie_path = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.cookie_file)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(cookie_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(cookie)</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">&quot;Cookie已保存&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">f&quot;保存Cookie失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_combined_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载已合并的数据&quot;&quot;&quot;</span></span><br><span class="line">        combined_path = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.combined_file)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(combined_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(combined_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    reader = csv.DictReader(f)</span><br><span class="line">                    comments = <span class="built_in">list</span>(reader)</span><br><span class="line">                    <span class="keyword">if</span> comments:</span><br><span class="line">                        <span class="comment"># 转换回原始格式</span></span><br><span class="line">                        converted = []</span><br><span class="line">                        <span class="keyword">for</span> c <span class="keyword">in</span> comments:</span><br><span class="line">                            converted.append(&#123;</span><br><span class="line">                                <span class="string">&#x27;rpid&#x27;</span>: <span class="built_in">int</span>(c[<span class="string">&#x27;rpid&#x27;</span>]),</span><br><span class="line">                                <span class="string">&#x27;user&#x27;</span>: &#123;</span><br><span class="line">                                    <span class="string">&#x27;uid&#x27;</span>: <span class="built_in">int</span>(c[<span class="string">&#x27;uid&#x27;</span>]),</span><br><span class="line">                                    <span class="string">&#x27;uname&#x27;</span>: c[<span class="string">&#x27;uname&#x27;</span>],</span><br><span class="line">                                    <span class="string">&#x27;avatar&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                <span class="string">&#x27;content&#x27;</span>: c[<span class="string">&#x27;content&#x27;</span>],</span><br><span class="line">                                <span class="string">&#x27;like&#x27;</span>: <span class="built_in">int</span>(c[<span class="string">&#x27;like&#x27;</span>]),</span><br><span class="line">                                <span class="string">&#x27;ctime&#x27;</span>: c[<span class="string">&#x27;ctime&#x27;</span>],</span><br><span class="line">                                <span class="string">&#x27;count&#x27;</span>: <span class="built_in">int</span>(c[<span class="string">&#x27;count&#x27;</span>]),</span><br><span class="line">                                <span class="string">&#x27;root&#x27;</span>: <span class="built_in">int</span>(c[<span class="string">&#x27;root&#x27;</span>]),</span><br><span class="line">                                <span class="string">&#x27;parent&#x27;</span>: <span class="built_in">int</span>(c[<span class="string">&#x27;parent&#x27;</span>]),</span><br><span class="line">                                <span class="string">&#x27;level&#x27;</span>: c[<span class="string">&#x27;level&#x27;</span>],</span><br><span class="line">                                <span class="string">&#x27;video_bvid&#x27;</span>: c.get(<span class="string">&#x27;video_bvid&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                            &#125;)</span><br><span class="line">                        <span class="variable language_">self</span>.crawler.comment_manager.add_comments(converted)</span><br><span class="line">                        <span class="variable language_">self</span>.log(<span class="string">f&quot;已加载 <span class="subst">&#123;<span class="built_in">len</span>(converted)&#125;</span> 条历史评论数据&quot;</span>)</span><br><span class="line">                        <span class="variable language_">self</span>.update_stats()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;加载合并数据失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear_combined_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清空合并的数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;crawler&#x27;</span>) <span class="keyword">and</span> <span class="variable language_">self</span>.crawler:</span><br><span class="line">            <span class="variable language_">self</span>.crawler.comment_manager.clear()</span><br><span class="line">            <span class="comment"># 删除合并文件</span></span><br><span class="line">            combined_path = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.combined_file)</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(combined_path):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    os.remove(combined_path)</span><br><span class="line">                    <span class="variable language_">self</span>.log(<span class="string">&quot;已清空合并数据文件&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="variable language_">self</span>.log(<span class="string">f&quot;删除合并文件失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">&quot;已清空合并数据&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.update_stats()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">export_combined_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;导出合并的数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;crawler&#x27;</span>) <span class="keyword">and</span> <span class="variable language_">self</span>.crawler:</span><br><span class="line">            comments = <span class="variable language_">self</span>.crawler.comment_manager.get_all_comments()</span><br><span class="line">            <span class="keyword">if</span> comments:</span><br><span class="line">                timestamp = datetime.now().strftime(<span class="string">&quot;%Y%m%d_%H%M%S&quot;</span>)</span><br><span class="line">                filename = <span class="string">f&quot;bilibili_comments_combined_export_<span class="subst">&#123;timestamp&#125;</span>.csv&quot;</span></span><br><span class="line">                save_path = os.path.join(<span class="variable language_">self</span>.script_dir, filename)</span><br><span class="line">                <span class="variable language_">self</span>._save_comments_to_csv(comments, save_path)</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;已导出 <span class="subst">&#123;<span class="built_in">len</span>(comments)&#125;</span> 条合并评论到 <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">&quot;没有可导出的合并数据&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_crawling</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;开始爬取评论&quot;&quot;&quot;</span></span><br><span class="line">        cookie = <span class="variable language_">self</span>.cookie_entry.get().strip()</span><br><span class="line">        bvid = <span class="variable language_">self</span>.bvid_entry.get().strip()</span><br><span class="line">        count = <span class="variable language_">self</span>.count_entry.get().strip()</span><br><span class="line">        sub_comments = <span class="variable language_">self</span>.sub_comments_entry.get().strip()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cookie:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;请输入B站Cookie&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> count.isdigit() <span class="keyword">or</span> <span class="built_in">int</span>(count) &lt;= <span class="number">0</span>:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;请输入有效的爬取数量&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> sub_comments.isdigit() <span class="keyword">or</span> <span class="built_in">int</span>(sub_comments) &lt; <span class="number">0</span>:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;请输入有效的二级评论数量(0表示不爬取二级评论)&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查自定义保存路径</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.save_location_var.get() == <span class="string">&quot;custom&quot;</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="variable language_">self</span>.path_entry.get().strip():</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;请选择保存路径或使用自动保存&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存Cookie</span></span><br><span class="line">        <span class="variable language_">self</span>.save_cookie(cookie)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化爬虫</span></span><br><span class="line">        <span class="variable language_">self</span>.crawler = BiliBiliCommentCrawler(cookie=cookie, log_callback=<span class="variable language_">self</span>.log)</span><br><span class="line">        <span class="variable language_">self</span>.crawler.set_max_sub_comments(<span class="built_in">int</span>(sub_comments))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果是多视频模式，加载历史数据</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.mode_var.get() == <span class="string">&quot;multi&quot;</span>:</span><br><span class="line">            <span class="variable language_">self</span>.load_combined_data()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 禁用开始按钮，启用停止按钮</span></span><br><span class="line">        <span class="variable language_">self</span>.start_button.config(state=DISABLED)</span><br><span class="line">        <span class="variable language_">self</span>.stop_button.config(state=NORMAL)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重置计数器和进度条</span></span><br><span class="line">        <span class="variable language_">self</span>.primary_count_var.<span class="built_in">set</span>(<span class="string">&quot;一级评论: 0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.secondary_count_var.<span class="built_in">set</span>(<span class="string">&quot;二级评论: 0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.progress_var.<span class="built_in">set</span>(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清空日志</span></span><br><span class="line">        <span class="variable language_">self</span>.log_text.delete(<span class="number">1.0</span>, END)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 准备BV号列表</span></span><br><span class="line">        <span class="keyword">if</span> bvid:  <span class="comment"># 如果输入框中有BV号，添加到列表开头</span></span><br><span class="line">            <span class="variable language_">self</span>.bvid_list.insert(<span class="number">0</span>, bvid)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.bvid_list:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;没有可爬取的视频BV号&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.start_button.config(state=NORMAL)</span><br><span class="line">            <span class="variable language_">self</span>.stop_button.config(state=DISABLED)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.current_bvid_index = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.video_progress_var.<span class="built_in">set</span>(<span class="string">f&quot;视频进度: 0/<span class="subst">&#123;<span class="built_in">len</span>(self.bvid_list)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.log(<span class="string">f&quot;开始爬取 <span class="subst">&#123;<span class="built_in">len</span>(self.bvid_list)&#125;</span> 个视频的评论...&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.log(<span class="string">f&quot;每个一级评论下最多爬取 <span class="subst">&#123;sub_comments&#125;</span> 条二级评论&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.update_stats()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 在新线程中运行爬虫</span></span><br><span class="line">        <span class="keyword">import</span> threading</span><br><span class="line">        thread = threading.Thread(</span><br><span class="line">            target=<span class="variable language_">self</span>._run_crawler_queue,</span><br><span class="line">            args=(<span class="built_in">int</span>(count),),</span><br><span class="line">            daemon=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        thread.start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_run_crawler_queue</span>(<span class="params">self, count: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行爬虫队列，依次爬取多个视频&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">for</span> i, bvid <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="variable language_">self</span>.bvid_list):</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.crawler.running:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">self</span>.current_bvid_index = i</span><br><span class="line">                <span class="variable language_">self</span>.root.after(<span class="number">0</span>, <span class="keyword">lambda</span>: <span class="variable language_">self</span>.video_progress_var.<span class="built_in">set</span>(<span class="string">f&quot;视频进度: <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>/<span class="subst">&#123;<span class="built_in">len</span>(self.bvid_list)&#125;</span>&quot;</span>))</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;正在爬取第 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>/<span class="subst">&#123;<span class="built_in">len</span>(self.bvid_list)&#125;</span> 个视频: <span class="subst">&#123;bvid&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 获取视频aid</span></span><br><span class="line">                aid = <span class="variable language_">self</span>.crawler.get_video_aid(bvid)</span><br><span class="line">                <span class="keyword">if</span> aid == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 获取已有评论数量（多视频模式下）</span></span><br><span class="line">                initial_count = <span class="built_in">len</span>(<span class="variable language_">self</span>.crawler.comment_manager.get_all_comments())</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 获取评论</span></span><br><span class="line">                added_count = <span class="variable language_">self</span>.crawler.get_comments(aid, max_count=count)</span><br><span class="line">                actual_count = initial_count + added_count</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 为每条评论添加视频来源标记</span></span><br><span class="line">                <span class="keyword">for</span> comment <span class="keyword">in</span> <span class="variable language_">self</span>.crawler.comment_manager.get_all_comments():</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;video_bvid&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> comment:</span><br><span class="line">                        comment[<span class="string">&#x27;video_bvid&#x27;</span>] = bvid</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 保存结果</span></span><br><span class="line">                <span class="keyword">if</span> actual_count &gt; initial_count <span class="keyword">and</span> <span class="variable language_">self</span>.mode_var.get() == <span class="string">&quot;multi&quot;</span>:</span><br><span class="line">                    <span class="comment"># 多视频模式保存到合并文件</span></span><br><span class="line">                    combined_path = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.combined_file)</span><br><span class="line">                    <span class="variable language_">self</span>._save_comments_to_csv(</span><br><span class="line">                        <span class="variable language_">self</span>.crawler.comment_manager.get_all_comments(), </span><br><span class="line">                        combined_path</span><br><span class="line">                    )</span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">self</span>.update_stats()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 全部完成后保存</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.crawler.running <span class="keyword">and</span> <span class="variable language_">self</span>.mode_var.get() == <span class="string">&quot;multi&quot;</span>:</span><br><span class="line">                combined_path = os.path.join(<span class="variable language_">self</span>.script_dir, <span class="variable language_">self</span>.combined_file)</span><br><span class="line">                <span class="variable language_">self</span>._save_comments_to_csv(</span><br><span class="line">                    <span class="variable language_">self</span>.crawler.comment_manager.get_all_comments(),</span><br><span class="line">                    combined_path</span><br><span class="line">                )</span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;已完成所有 <span class="subst">&#123;<span class="built_in">len</span>(self.bvid_list)&#125;</span> 个视频的爬取，总评论数: <span class="subst">&#123;<span class="built_in">len</span>(self.crawler.comment_manager.get_all_comments())&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="variable language_">self</span>.crawler.running <span class="keyword">and</span> <span class="variable language_">self</span>.mode_var.get() == <span class="string">&quot;single&quot;</span>:</span><br><span class="line">                <span class="comment"># 单视频模式单独保存</span></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.save_location_var.get() == <span class="string">&quot;custom&quot;</span>:</span><br><span class="line">                    save_path = <span class="variable language_">self</span>.path_entry.get().strip()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    timestamp = datetime.now().strftime(<span class="string">&quot;%Y%m%d_%H%M%S&quot;</span>)</span><br><span class="line">                    status = <span class="string">&quot;partial&quot;</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.crawler.running <span class="keyword">else</span> <span class="string">&quot;full&quot;</span></span><br><span class="line">                    filename = <span class="string">f&quot;bilibili_comments_<span class="subst">&#123;self.bvid_list[<span class="number">0</span>]&#125;</span>_<span class="subst">&#123;status&#125;</span>_<span class="subst">&#123;timestamp&#125;</span>.csv&quot;</span></span><br><span class="line">                    save_path = os.path.join(<span class="variable language_">self</span>.script_dir, filename)</span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">self</span>._save_comments_to_csv(</span><br><span class="line">                    <span class="variable language_">self</span>.crawler.comment_manager.get_all_comments(),</span><br><span class="line">                    save_path</span><br><span class="line">                )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">f&quot;爬取过程中发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># 恢复按钮状态</span></span><br><span class="line">            <span class="variable language_">self</span>.root.after(<span class="number">0</span>, <span class="keyword">lambda</span>: <span class="variable language_">self</span>.start_button.config(state=NORMAL))</span><br><span class="line">            <span class="variable language_">self</span>.root.after(<span class="number">0</span>, <span class="keyword">lambda</span>: <span class="variable language_">self</span>.stop_button.config(state=DISABLED))</span><br><span class="line">            <span class="comment"># 单视频模式清空数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.mode_var.get() == <span class="string">&quot;single&quot;</span>:</span><br><span class="line">                <span class="variable language_">self</span>.crawler.comment_manager.clear()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop_crawling</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;停止爬取并保存数据&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.crawler:</span><br><span class="line">            <span class="variable language_">self</span>.crawler.stop()</span><br><span class="line">            <span class="variable language_">self</span>.stop_button.config(state=DISABLED)</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">&quot;正在保存已获取的评论数据...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_save_comments_to_csv</span>(<span class="params">self, comments: <span class="type">List</span>[<span class="type">Dict</span>], file_path: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存评论到CSV文件（内部方法）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 确保目录存在</span></span><br><span class="line">            os.makedirs(os.path.dirname(file_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查文件是否已存在（合并模式）</span></span><br><span class="line">            file_exists = os.path.isfile(file_path)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 读取已有评论ID（仅合并模式）</span></span><br><span class="line">            existing_rpids = <span class="built_in">set</span>()</span><br><span class="line">            <span class="keyword">if</span> file_exists <span class="keyword">and</span> <span class="variable language_">self</span>.mode_var.get() == <span class="string">&quot;multi&quot;</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        reader = csv.DictReader(f)</span><br><span class="line">                        <span class="keyword">if</span> reader.fieldnames:  <span class="comment"># 确保文件有表头</span></span><br><span class="line">                            <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">                                <span class="keyword">try</span>:</span><br><span class="line">                                    existing_rpids.add(<span class="built_in">int</span>(row[<span class="string">&#x27;rpid&#x27;</span>]))</span><br><span class="line">                                <span class="keyword">except</span> (KeyError, ValueError):</span><br><span class="line">                                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="variable language_">self</span>.log(<span class="string">f&quot;读取现有评论文件时出错: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="comment"># 如果读取失败，创建新文件</span></span><br><span class="line">                    file_exists = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 准备写入模式</span></span><br><span class="line">            write_header = <span class="keyword">not</span> file_exists <span class="keyword">or</span> <span class="variable language_">self</span>.mode_var.get() != <span class="string">&quot;multi&quot;</span></span><br><span class="line">            mode = <span class="string">&#x27;a&#x27;</span> <span class="keyword">if</span> file_exists <span class="keyword">and</span> <span class="variable language_">self</span>.mode_var.get() == <span class="string">&quot;multi&quot;</span> <span class="keyword">else</span> <span class="string">&#x27;w&#x27;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, mode, newline=<span class="string">&#x27;&#x27;</span>, encoding=<span class="string">&#x27;utf-8-sig&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">                fieldnames = [</span><br><span class="line">                    <span class="string">&#x27;rpid&#x27;</span>, <span class="string">&#x27;level&#x27;</span>, <span class="string">&#x27;uname&#x27;</span>, <span class="string">&#x27;uid&#x27;</span>, </span><br><span class="line">                    <span class="string">&#x27;content&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;ctime&#x27;</span>, <span class="string">&#x27;count&#x27;</span>, </span><br><span class="line">                    <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;parent&#x27;</span>, <span class="string">&#x27;video_bvid&#x27;</span></span><br><span class="line">                ]</span><br><span class="line">                writer = csv.DictWriter(csvfile, fieldnames=fieldnames)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> write_header:</span><br><span class="line">                    writer.writeheader()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 写入新评论（自动去重）</span></span><br><span class="line">                added_count = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> comment <span class="keyword">in</span> comments:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="comment"># 确保评论包含所有必要字段</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(key <span class="keyword">in</span> comment <span class="keyword">for</span> key <span class="keyword">in</span> [<span class="string">&#x27;rpid&#x27;</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;content&#x27;</span>]):</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                            </span><br><span class="line">                        <span class="keyword">if</span> <span class="built_in">int</span>(comment[<span class="string">&#x27;rpid&#x27;</span>]) <span class="keyword">not</span> <span class="keyword">in</span> existing_rpids:</span><br><span class="line">                            row = &#123;</span><br><span class="line">                                <span class="string">&#x27;rpid&#x27;</span>: comment[<span class="string">&#x27;rpid&#x27;</span>],</span><br><span class="line">                                <span class="string">&#x27;level&#x27;</span>: comment.get(<span class="string">&#x27;level&#x27;</span>, <span class="string">&#x27;一级&#x27;</span>),</span><br><span class="line">                                <span class="string">&#x27;uname&#x27;</span>: comment[<span class="string">&#x27;user&#x27;</span>].get(<span class="string">&#x27;uname&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                                <span class="string">&#x27;uid&#x27;</span>: comment[<span class="string">&#x27;user&#x27;</span>].get(<span class="string">&#x27;uid&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                                <span class="string">&#x27;content&#x27;</span>: comment[<span class="string">&#x27;content&#x27;</span>],</span><br><span class="line">                                <span class="string">&#x27;like&#x27;</span>: comment.get(<span class="string">&#x27;like&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                                <span class="string">&#x27;ctime&#x27;</span>: comment.get(<span class="string">&#x27;ctime&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                                <span class="string">&#x27;count&#x27;</span>: comment.get(<span class="string">&#x27;count&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                                <span class="string">&#x27;root&#x27;</span>: comment.get(<span class="string">&#x27;root&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                                <span class="string">&#x27;parent&#x27;</span>: comment.get(<span class="string">&#x27;parent&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                                <span class="string">&#x27;video_bvid&#x27;</span>: comment.get(<span class="string">&#x27;video_bvid&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                            &#125;</span><br><span class="line">                            writer.writerow(row)</span><br><span class="line">                            added_count += <span class="number">1</span></span><br><span class="line">                            existing_rpids.add(<span class="built_in">int</span>(comment[<span class="string">&#x27;rpid&#x27;</span>]))  <span class="comment"># 更新已存在集合</span></span><br><span class="line">                    <span class="keyword">except</span> (KeyError, ValueError, AttributeError) <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="variable language_">self</span>.log(<span class="string">f&quot;跳过无效评论: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="variable language_">self</span>.log(<span class="string">f&quot;已成功保存 <span class="subst">&#123;added_count&#125;</span> 条新评论到 <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(comments) - added_count &gt; <span class="number">0</span>:</span><br><span class="line">                    <span class="variable language_">self</span>.log(<span class="string">f&quot;跳过 <span class="subst">&#123;<span class="built_in">len</span>(comments) - added_count&#125;</span> 条重复或无效评论&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.log(<span class="string">f&quot;保存CSV文件失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    root = Tk()</span><br><span class="line">    app = BiliBiliCommentGUI(root)</span><br><span class="line">    root.mainloop()</span><br></pre></td></tr></table></figure>

<h3 id="3-评论分析模块-quchong-ver4-py-1"><a href="#3-评论分析模块-quchong-ver4-py-1" class="headerlink" title="3.评论分析模块(quchong_ver4.py)"></a>3.评论分析模块(quchong_ver4.py)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> tkinter <span class="keyword">as</span> tk</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> filedialog, messagebox, ttk</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tkinter.scrolledtext <span class="keyword">import</span> ScrolledText</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BiliCommentAnalyzerPro</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="variable language_">self</span>.root = root</span><br><span class="line">        <span class="variable language_">self</span>.root.title(<span class="string">&quot;B站评论专业分析器 v4.0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.root.geometry(<span class="string">&quot;900x650&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化数据</span></span><br><span class="line">        <span class="variable language_">self</span>.df = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.current_results = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 样式设置</span></span><br><span class="line">        <span class="variable language_">self</span>.setup_styles()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建界面</span></span><br><span class="line">        <span class="variable language_">self</span>.setup_ui()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_styles</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置界面样式&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.style = ttk.Style()</span><br><span class="line">        <span class="variable language_">self</span>.style.configure(<span class="string">&#x27;TFrame&#x27;</span>, background=<span class="string">&#x27;#f0f0f0&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.style.configure(<span class="string">&#x27;TLabel&#x27;</span>, background=<span class="string">&#x27;#f0f0f0&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.style.configure(<span class="string">&#x27;Title.TLabel&#x27;</span>, font=(<span class="string">&#x27;Arial&#x27;</span>, <span class="number">12</span>, <span class="string">&#x27;bold&#x27;</span>))</span><br><span class="line">        <span class="variable language_">self</span>.style.configure(<span class="string">&#x27;Highlight.TFrame&#x27;</span>, background=<span class="string">&#x27;#e0e0e0&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_ui</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置主界面&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 主框架</span></span><br><span class="line">        <span class="variable language_">self</span>.main_frame = ttk.Frame(<span class="variable language_">self</span>.root, padding=<span class="string">&quot;10&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.main_frame.pack(fill=tk.BOTH, expand=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 文件操作区域</span></span><br><span class="line">        <span class="variable language_">self</span>.setup_file_section()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分析选项区域</span></span><br><span class="line">        <span class="variable language_">self</span>.setup_analysis_section()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 结果显示区域</span></span><br><span class="line">        <span class="variable language_">self</span>.setup_results_section()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 状态栏</span></span><br><span class="line">        <span class="variable language_">self</span>.setup_status_bar()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_file_section</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置文件操作区域&quot;&quot;&quot;</span></span><br><span class="line">        file_frame = ttk.LabelFrame(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;文件操作&quot;</span>, padding=<span class="string">&quot;10&quot;</span>)</span><br><span class="line">        file_frame.pack(fill=tk.X, pady=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 输入文件</span></span><br><span class="line">        input_frame = ttk.Frame(file_frame)</span><br><span class="line">        input_frame.pack(fill=tk.X, pady=<span class="number">5</span>)</span><br><span class="line">        ttk.Label(input_frame, text=<span class="string">&quot;输入文件:&quot;</span>).pack(side=tk.LEFT)</span><br><span class="line">        <span class="variable language_">self</span>.input_entry = ttk.Entry(input_frame, width=<span class="number">60</span>)</span><br><span class="line">        <span class="variable language_">self</span>.input_entry.pack(side=tk.LEFT, expand=<span class="literal">True</span>, fill=tk.X, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Button(input_frame, text=<span class="string">&quot;浏览...&quot;</span>, command=<span class="variable language_">self</span>.browse_input).pack(side=tk.LEFT)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 操作按钮</span></span><br><span class="line">        btn_frame = ttk.Frame(file_frame)</span><br><span class="line">        btn_frame.pack(fill=tk.X, pady=<span class="number">5</span>)</span><br><span class="line">        ttk.Button(btn_frame, text=<span class="string">&quot;加载数据&quot;</span>, command=<span class="variable language_">self</span>.load_data).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Button(btn_frame, text=<span class="string">&quot;保存分析结果&quot;</span>, command=<span class="variable language_">self</span>.save_analysis).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Button(btn_frame, text=<span class="string">&quot;导出筛选结果&quot;</span>, command=<span class="variable language_">self</span>.export_results).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_analysis_section</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置分析选项区域&quot;&quot;&quot;</span></span><br><span class="line">        analysis_frame = ttk.LabelFrame(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;分析选项&quot;</span>, padding=<span class="string">&quot;10&quot;</span>)</span><br><span class="line">        analysis_frame.pack(fill=tk.X, pady=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 去重选项</span></span><br><span class="line">        dedupe_frame = ttk.Frame(analysis_frame)</span><br><span class="line">        dedupe_frame.pack(fill=tk.X, pady=<span class="number">5</span>)</span><br><span class="line">        ttk.Label(dedupe_frame, text=<span class="string">&quot;去重方式:&quot;</span>).pack(side=tk.LEFT)</span><br><span class="line">        <span class="variable language_">self</span>.dedupe_var = tk.StringVar(value=<span class="string">&quot;all&quot;</span>)</span><br><span class="line">        ttk.Radiobutton(dedupe_frame, text=<span class="string">&quot;全列匹配&quot;</span>, variable=<span class="variable language_">self</span>.dedupe_var, value=<span class="string">&quot;all&quot;</span>).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Radiobutton(dedupe_frame, text=<span class="string">&quot;仅内容&quot;</span>, variable=<span class="variable language_">self</span>.dedupe_var, value=<span class="string">&quot;content&quot;</span>).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 诗体分析选项</span></span><br><span class="line">        poem_frame = ttk.Frame(analysis_frame)</span><br><span class="line">        poem_frame.pack(fill=tk.X, pady=<span class="number">5</span>)</span><br><span class="line">        <span class="variable language_">self</span>.poem_var = tk.IntVar(value=<span class="number">1</span>)</span><br><span class="line">        ttk.Checkbutton(poem_frame, text=<span class="string">&quot;分析诗体评论&quot;</span>, variable=<span class="variable language_">self</span>.poem_var).pack(side=tk.LEFT)</span><br><span class="line">        </span><br><span class="line">        poem_option_frame = ttk.Frame(analysis_frame)</span><br><span class="line">        poem_option_frame.pack(fill=tk.X, pady=<span class="number">5</span>)</span><br><span class="line">        ttk.Label(poem_option_frame, text=<span class="string">&quot;诗体定义:&quot;</span>).pack(side=tk.LEFT)</span><br><span class="line">        <span class="variable language_">self</span>.poem_line_var = tk.IntVar(value=<span class="number">3</span>)</span><br><span class="line">        ttk.Spinbox(poem_option_frame, from_=<span class="number">2</span>, to=<span class="number">10</span>, width=<span class="number">3</span>, textvariable=<span class="variable language_">self</span>.poem_line_var).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Label(poem_option_frame, text=<span class="string">&quot;个分行 | 包含二级评论:&quot;</span>).pack(side=tk.LEFT)</span><br><span class="line">        <span class="variable language_">self</span>.include_replies_var = tk.IntVar(value=<span class="number">1</span>)</span><br><span class="line">        ttk.Checkbutton(poem_option_frame, variable=<span class="variable language_">self</span>.include_replies_var).pack(side=tk.LEFT)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 排序选项</span></span><br><span class="line">        sort_frame = ttk.Frame(analysis_frame)</span><br><span class="line">        sort_frame.pack(fill=tk.X, pady=<span class="number">5</span>)</span><br><span class="line">        ttk.Label(sort_frame, text=<span class="string">&quot;排序方式:&quot;</span>).pack(side=tk.LEFT)</span><br><span class="line">        <span class="variable language_">self</span>.sort_var = tk.StringVar(value=<span class="string">&quot;like&quot;</span>)</span><br><span class="line">        ttk.Radiobutton(sort_frame, text=<span class="string">&quot;按点赞数&quot;</span>, variable=<span class="variable language_">self</span>.sort_var, value=<span class="string">&quot;like&quot;</span>).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Radiobutton(sort_frame, text=<span class="string">&quot;按时间&quot;</span>, variable=<span class="variable language_">self</span>.sort_var, value=<span class="string">&quot;ctime&quot;</span>).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分析按钮</span></span><br><span class="line">        ttk.Button(analysis_frame, text=<span class="string">&quot;执行分析&quot;</span>, command=<span class="variable language_">self</span>.analyze_comments).pack(pady=<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_results_section</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置结果显示区域&quot;&quot;&quot;</span></span><br><span class="line">        result_frame = ttk.LabelFrame(<span class="variable language_">self</span>.main_frame, text=<span class="string">&quot;分析结果&quot;</span>, padding=<span class="string">&quot;10&quot;</span>)</span><br><span class="line">        result_frame.pack(fill=tk.BOTH, expand=<span class="literal">True</span>, pady=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 结果显示文本框</span></span><br><span class="line">        <span class="variable language_">self</span>.result_text = ScrolledText(result_frame, wrap=tk.WORD, font=(<span class="string">&#x27;Arial&#x27;</span>, <span class="number">10</span>))</span><br><span class="line">        <span class="variable language_">self</span>.result_text.pack(fill=tk.BOTH, expand=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 结果统计信息</span></span><br><span class="line">        <span class="variable language_">self</span>.stats_frame = ttk.Frame(result_frame, style=<span class="string">&#x27;Highlight.TFrame&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.stats_frame.pack(fill=tk.X, pady=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.stats_vars = &#123;</span><br><span class="line">            <span class="string">&#x27;total&#x27;</span>: tk.StringVar(),</span><br><span class="line">            <span class="string">&#x27;poetic&#x27;</span>: tk.StringVar(),</span><br><span class="line">            <span class="string">&#x27;avg_likes&#x27;</span>: tk.StringVar(),</span><br><span class="line">            <span class="string">&#x27;time_range&#x27;</span>: tk.StringVar()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.stats_frame, text=<span class="string">&quot;总评论:&quot;</span>).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.stats_frame, textvariable=<span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;total&#x27;</span>]).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.stats_frame, text=<span class="string">&quot;诗体评论:&quot;</span>).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.stats_frame, textvariable=<span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;poetic&#x27;</span>]).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.stats_frame, text=<span class="string">&quot;平均点赞:&quot;</span>).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.stats_frame, textvariable=<span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;avg_likes&#x27;</span>]).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.stats_frame, text=<span class="string">&quot;时间范围:&quot;</span>).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.stats_frame, textvariable=<span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;time_range&#x27;</span>]).pack(side=tk.LEFT, padx=<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_status_bar</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设置状态栏&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.status_var = tk.StringVar()</span><br><span class="line">        <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">&quot;准备就绪&quot;</span>)</span><br><span class="line">        ttk.Label(<span class="variable language_">self</span>.main_frame, textvariable=<span class="variable language_">self</span>.status_var, relief=tk.SUNKEN).pack(fill=tk.X, pady=(<span class="number">5</span>,<span class="number">0</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">browse_input</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;浏览输入文件&quot;&quot;&quot;</span></span><br><span class="line">        filename = filedialog.askopenfilename(</span><br><span class="line">            title=<span class="string">&quot;选择输入文件&quot;</span>,</span><br><span class="line">            filetypes=[(<span class="string">&quot;CSV文件&quot;</span>, <span class="string">&quot;*.csv&quot;</span>), (<span class="string">&quot;所有文件&quot;</span>, <span class="string">&quot;*.*&quot;</span>)]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> filename:</span><br><span class="line">            <span class="variable language_">self</span>.input_entry.delete(<span class="number">0</span>, tk.END)</span><br><span class="line">            <span class="variable language_">self</span>.input_entry.insert(<span class="number">0</span>, filename)</span><br><span class="line">            <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;已选择文件: <span class="subst">&#123;os.path.basename(filename)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载数据&quot;&quot;&quot;</span></span><br><span class="line">        input_file = <span class="variable language_">self</span>.input_entry.get()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> input_file:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;请先选择输入文件&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 读取CSV文件并转换时间格式</span></span><br><span class="line">            <span class="variable language_">self</span>.df = pd.read_csv(input_file, encoding=<span class="string">&#x27;utf-8-sig&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;ctime&#x27;</span> <span class="keyword">in</span> <span class="variable language_">self</span>.df.columns:</span><br><span class="line">                <span class="variable language_">self</span>.df[<span class="string">&#x27;ctime&#x27;</span>] = pd.to_datetime(<span class="variable language_">self</span>.df[<span class="string">&#x27;ctime&#x27;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;数据加载成功，共 <span class="subst">&#123;<span class="built_in">len</span>(self.df)&#125;</span> 条评论&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.update_stats()</span><br><span class="line">            messagebox.showinfo(<span class="string">&quot;成功&quot;</span>, <span class="string">&quot;数据加载成功！&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">f&quot;加载数据失败:\n<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_analysis</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存分析结果（包括所有数据和设置）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;df&#x27;</span>) <span class="keyword">or</span> <span class="variable language_">self</span>.df <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;没有可保存的分析数据&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 获取保存路径</span></span><br><span class="line">            save_path = filedialog.asksaveasfilename(</span><br><span class="line">                defaultextension=<span class="string">&quot;.pkl&quot;</span>,</span><br><span class="line">                filetypes=[(<span class="string">&quot;分析文件&quot;</span>, <span class="string">&quot;*.pkl&quot;</span>), (<span class="string">&quot;所有文件&quot;</span>, <span class="string">&quot;*.*&quot;</span>)],</span><br><span class="line">                title=<span class="string">&quot;保存分析结果&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> save_path:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 准备保存数据</span></span><br><span class="line">            save_data = &#123;</span><br><span class="line">                <span class="string">&#x27;data&#x27;</span>: <span class="variable language_">self</span>.df,</span><br><span class="line">                <span class="string">&#x27;settings&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;dedupe&#x27;</span>: <span class="variable language_">self</span>.dedupe_var.get(),</span><br><span class="line">                    <span class="string">&#x27;poem_lines&#x27;</span>: <span class="variable language_">self</span>.poem_line_var.get(),</span><br><span class="line">                    <span class="string">&#x27;include_replies&#x27;</span>: <span class="variable language_">self</span>.include_replies_var.get(),</span><br><span class="line">                    <span class="string">&#x27;sort_by&#x27;</span>: <span class="variable language_">self</span>.sort_var.get()</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&#x27;results&#x27;</span>: <span class="variable language_">self</span>.current_results <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;current_results&#x27;</span>) <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                <span class="string">&#x27;stats&#x27;</span>: &#123;k: v.get() <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="variable language_">self</span>.stats_vars.items()&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 保存为pickle文件</span></span><br><span class="line">            pd.to_pickle(save_data, save_path)</span><br><span class="line">            <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;分析结果已保存到: <span class="subst">&#123;save_path&#125;</span>&quot;</span>)</span><br><span class="line">            messagebox.showinfo(<span class="string">&quot;成功&quot;</span>, <span class="string">&quot;分析结果保存成功！&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">f&quot;保存失败:\n<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;保存错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_comments</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析评论&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;df&#x27;</span>) <span class="keyword">or</span> <span class="variable language_">self</span>.df <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;请先加载数据&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 复制原始数据</span></span><br><span class="line">            df = <span class="variable language_">self</span>.df.copy()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 去重处理</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.dedupe_var.get() == <span class="string">&quot;content&quot;</span>:</span><br><span class="line">                df = df.drop_duplicates(subset=[<span class="string">&#x27;content&#x27;</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                df = df.drop_duplicates()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 诗体评论分析</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.poem_var.get():</span><br><span class="line">                df = <span class="variable language_">self</span>.analyze_poetic_comments(df)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 排序处理</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.sort_var.get() == <span class="string">&quot;like&quot;</span>:</span><br><span class="line">                df = df.sort_values(by=<span class="string">&#x27;like&#x27;</span>, ascending=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                df = df.sort_values(by=<span class="string">&#x27;ctime&#x27;</span>, ascending=<span class="literal">False</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 保存当前结果</span></span><br><span class="line">            <span class="variable language_">self</span>.current_results = df</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 显示结果</span></span><br><span class="line">            <span class="variable language_">self</span>.display_results(df)</span><br><span class="line">            <span class="variable language_">self</span>.update_stats(df)</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;分析完成，共 <span class="subst">&#123;<span class="built_in">len</span>(df)&#125;</span> 条结果&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">f&quot;分析过程中出错:\n<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_poetic_comments</span>(<span class="params">self, df</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析诗体评论（包括二级评论）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 计算换行数</span></span><br><span class="line">        df[<span class="string">&#x27;line_breaks&#x27;</span>] = df[<span class="string">&#x27;content&#x27;</span>].<span class="built_in">str</span>.count(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取诗体评论</span></span><br><span class="line">        min_lines = <span class="variable language_">self</span>.poem_line_var.get()</span><br><span class="line">        poetic_mask = df[<span class="string">&#x27;line_breaks&#x27;</span>] &gt;= (min_lines - <span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果需要包含二级评论</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.include_replies_var.get():</span><br><span class="line">            <span class="comment"># 获取所有一级评论的root ID</span></span><br><span class="line">            root_ids = <span class="built_in">set</span>(df[poetic_mask][<span class="string">&#x27;rpid&#x27;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 找出所有相关二级评论</span></span><br><span class="line">            reply_mask = df[<span class="string">&#x27;root&#x27;</span>].isin(root_ids)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 合并结果</span></span><br><span class="line">            poetic_mask = poetic_mask | reply_mask</span><br><span class="line">        </span><br><span class="line">        poetic_comments = df[poetic_mask].copy()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 添加诗体类型标记</span></span><br><span class="line">        poetic_comments[<span class="string">&#x27;poem_type&#x27;</span>] = poetic_comments[<span class="string">&#x27;line_breaks&#x27;</span>].apply(</span><br><span class="line">            <span class="keyword">lambda</span> x: <span class="string">f&quot;<span class="subst">&#123;x+<span class="number">1</span>&#125;</span>行诗体&quot;</span> <span class="keyword">if</span> x &gt;= (min_lines - <span class="number">1</span>) <span class="keyword">else</span> <span class="string">&quot;相关回复&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;找到 <span class="subst">&#123;<span class="built_in">len</span>(poetic_comments)&#125;</span> 条诗体评论及相关回复&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> poetic_comments</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display_results</span>(<span class="params">self, df</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;显示分析结果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.result_text.delete(<span class="number">1.0</span>, tk.END)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> df <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> df.empty:</span><br><span class="line">            <span class="variable language_">self</span>.result_text.insert(tk.END, <span class="string">&quot;没有可显示的结果&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 显示前50条评论</span></span><br><span class="line">        <span class="keyword">for</span> idx, row <span class="keyword">in</span> df.head(<span class="number">50</span>).iterrows():</span><br><span class="line">            <span class="comment"># 添加诗体标记（如果存在）</span></span><br><span class="line">            poem_tag = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;poem_type&#x27;</span> <span class="keyword">in</span> row:</span><br><span class="line">                poem_tag = <span class="string">f&quot; [<span class="subst">&#123;row[<span class="string">&#x27;poem_type&#x27;</span>]&#125;</span>]&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.result_text.insert(tk.END, <span class="string">f&quot;【<span class="subst">&#123;idx&#125;</span>】点赞: <span class="subst">&#123;row.get(<span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span> 时间: <span class="subst">&#123;row.get(<span class="string">&#x27;ctime&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span><span class="subst">&#123;poem_tag&#125;</span>\n&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.result_text.insert(tk.END, <span class="string">f&quot;用户: <span class="subst">&#123;row.get(<span class="string">&#x27;uname&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span> (UID: <span class="subst">&#123;row.get(<span class="string">&#x27;uid&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>)\n&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 高亮显示诗体评论内容</span></span><br><span class="line">            content = row.get(<span class="string">&#x27;content&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;poem_type&#x27;</span> <span class="keyword">in</span> row <span class="keyword">and</span> <span class="string">&quot;诗体&quot;</span> <span class="keyword">in</span> row[<span class="string">&#x27;poem_type&#x27;</span>]:</span><br><span class="line">                <span class="variable language_">self</span>.result_text.insert(tk.END, <span class="string">&quot;内容:\n&quot;</span>, <span class="string">&#x27;poem&#x27;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.result_text.insert(tk.END, <span class="string">f&quot;<span class="subst">&#123;content&#125;</span>\n&quot;</span>, <span class="string">&#x27;poem&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.result_text.insert(tk.END, <span class="string">&quot;内容:\n&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.result_text.insert(tk.END, <span class="string">f&quot;<span class="subst">&#123;content&#125;</span>\n&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.result_text.insert(tk.END, <span class="string">&quot;-&quot;</span>*<span class="number">70</span> + <span class="string">&quot;\n\n&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 配置文本样式</span></span><br><span class="line">        <span class="variable language_">self</span>.result_text.tag_configure(<span class="string">&#x27;poem&#x27;</span>, foreground=<span class="string">&#x27;blue&#x27;</span>, font=(<span class="string">&#x27;Arial&#x27;</span>, <span class="number">10</span>, <span class="string">&#x27;italic&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_stats</span>(<span class="params">self, df=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;更新统计信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> df <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            df = <span class="variable language_">self</span>.df <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;df&#x27;</span>) <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> df <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> df.empty:</span><br><span class="line">            <span class="keyword">for</span> var <span class="keyword">in</span> <span class="variable language_">self</span>.stats_vars.values():</span><br><span class="line">                var.<span class="built_in">set</span>(<span class="string">&quot;N/A&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 总评论数</span></span><br><span class="line">        <span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;total&#x27;</span>].<span class="built_in">set</span>(<span class="built_in">len</span>(df))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 诗体评论数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;line_breaks&#x27;</span> <span class="keyword">in</span> df.columns:</span><br><span class="line">            poetic_count = <span class="built_in">len</span>(df[df[<span class="string">&#x27;line_breaks&#x27;</span>] &gt;= (<span class="variable language_">self</span>.poem_line_var.get() - <span class="number">1</span>)])</span><br><span class="line">            <span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;poetic&#x27;</span>].<span class="built_in">set</span>(<span class="string">f&quot;<span class="subst">&#123;poetic_count&#125;</span> (<span class="subst">&#123;(poetic_count/<span class="built_in">len</span>(df)*<span class="number">100</span>):<span class="number">.1</span>f&#125;</span>%)&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;poetic&#x27;</span>].<span class="built_in">set</span>(<span class="string">&quot;N/A&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 平均点赞数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;like&#x27;</span> <span class="keyword">in</span> df.columns:</span><br><span class="line">            avg_likes = df[<span class="string">&#x27;like&#x27;</span>].mean()</span><br><span class="line">            <span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;avg_likes&#x27;</span>].<span class="built_in">set</span>(<span class="string">f&quot;<span class="subst">&#123;avg_likes:<span class="number">.1</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;avg_likes&#x27;</span>].<span class="built_in">set</span>(<span class="string">&quot;N/A&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 时间范围</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;ctime&#x27;</span> <span class="keyword">in</span> df.columns <span class="keyword">and</span> pd.api.types.is_datetime64_any_dtype(df[<span class="string">&#x27;ctime&#x27;</span>]):</span><br><span class="line">            min_time = df[<span class="string">&#x27;ctime&#x27;</span>].<span class="built_in">min</span>()</span><br><span class="line">            max_time = df[<span class="string">&#x27;ctime&#x27;</span>].<span class="built_in">max</span>()</span><br><span class="line">            <span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;time_range&#x27;</span>].<span class="built_in">set</span>(<span class="string">f&quot;<span class="subst">&#123;min_time.date()&#125;</span> 至 <span class="subst">&#123;max_time.date()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.stats_vars[<span class="string">&#x27;time_range&#x27;</span>].<span class="built_in">set</span>(<span class="string">&quot;N/A&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">export_results</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;导出筛选结果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(<span class="variable language_">self</span>, <span class="string">&#x27;current_results&#x27;</span>) <span class="keyword">or</span> <span class="variable language_">self</span>.current_results <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">&quot;没有可导出的结果&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 获取保存路径</span></span><br><span class="line">            save_path = filedialog.asksaveasfilename(</span><br><span class="line">                defaultextension=<span class="string">&quot;.csv&quot;</span>,</span><br><span class="line">                filetypes=[(<span class="string">&quot;CSV文件&quot;</span>, <span class="string">&quot;*.csv&quot;</span>), (<span class="string">&quot;Excel文件&quot;</span>, <span class="string">&quot;*.xlsx&quot;</span>), (<span class="string">&quot;所有文件&quot;</span>, <span class="string">&quot;*.*&quot;</span>)],</span><br><span class="line">                title=<span class="string">&quot;导出筛选结果&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> save_path:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 根据文件类型保存</span></span><br><span class="line">            <span class="keyword">if</span> save_path.endswith(<span class="string">&#x27;.csv&#x27;</span>):</span><br><span class="line">                <span class="variable language_">self</span>.current_results.to_csv(save_path, index=<span class="literal">False</span>, encoding=<span class="string">&#x27;utf-8-sig&#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> save_path.endswith(<span class="string">&#x27;.xlsx&#x27;</span>):</span><br><span class="line">                <span class="variable language_">self</span>.current_results.to_excel(save_path, index=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.current_results.to_csv(save_path, index=<span class="literal">False</span>, encoding=<span class="string">&#x27;utf-8-sig&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;结果已导出到: <span class="subst">&#123;save_path&#125;</span>&quot;</span>)</span><br><span class="line">            messagebox.showinfo(<span class="string">&quot;成功&quot;</span>, <span class="string">&quot;筛选结果导出成功！&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            messagebox.showerror(<span class="string">&quot;错误&quot;</span>, <span class="string">f&quot;导出失败:\n<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.status_var.<span class="built_in">set</span>(<span class="string">f&quot;导出错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    root = tk.Tk()</span><br><span class="line">    app = BiliCommentAnalyzerPro(root)</span><br><span class="line">    root.mainloop()</span><br></pre></td></tr></table></figure>



<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>该系统为B站评论分析提供了完整的解决方案，从数据采集到分析处理形成闭环。经过实际验证，系统稳定可靠，能够满足大规模数据采集需求。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://lnterlink.site">Lnterlink</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://lnterlink.site/2025/07/21/%E4%BB%A3%E7%A0%81%E5%8F%8A%E4%BB%A3%E7%A0%81%E9%98%90%E9%87%8A/">https://lnterlink.site/2025/07/21/%E4%BB%A3%E7%A0%81%E5%8F%8A%E4%BB%A3%E7%A0%81%E9%98%90%E9%87%8A/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://lnterlink.site" target="_blank">Lnterlink的小屋</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/%E8%96%AF%E7%89%87%E5%85%8D%E6%89%A3%E5%9B%BE%E8%8A%B1%E8%84%B8.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/06/09/%E6%8F%89%E6%90%93%E8%B5%B7%E6%9D%A5%E7%9A%84%E6%96%87%E5%AD%97/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2"></div></div><div class="info-2"><div class="info-item-1">揉搓起来的文字 6.9汗腺、流动 毛孔变得沉重 恶意 错误 不周到的事实 刻意导向的观点 呆滞地 把观点藏进 可怕的地方 一个人孤独  爱意 过分地 在匿名地 机械舞动 即使知道是虚假的 即使知道是多余的 即使知道是夸大的 即使知道是抱着不同的 但是全盘接受 像无意识地降生 全盘接受这个XX 不完美般 活着 如果还有什么能抽离 如果还有什么能逃跑 如果还有什么能站着 那就容我坠落吧 我知道 所谓的向上 不过是 向天空臣服 既然 真实无法被证伪 个体无法被证实 因此 我接受 虚假的爱 平面的肉体 抽象了的美丽  6.16</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E8%96%AF%E7%89%87%E5%85%8D%E6%89%A3%E5%9B%BE%E8%8A%B1%E8%84%B8.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Lnterlink</div><div class="author-info-description">愿爱无忧 --maojiangjiang492@gmail.com</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lnterlink"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Lnterlink" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:maojiangjiang492@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">你好，这里是我的博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Python-B%E7%AB%99%E7%88%AC%E8%99%AB%E4%BB%A3%E7%A0%81%E9%98%90%E9%87%8A"><span class="toc-number">1.</span> <span class="toc-text">Python B站爬虫代码阐释</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">项目概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.</span> <span class="toc-text">模块功能详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%AF%84%E8%AE%BA%E7%88%AC%E5%8F%96%E6%A8%A1%E5%9D%97-b-ver7-py"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 评论爬取模块 (b_ver7.py)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">核心功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E7%89%B9%E7%82%B9"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">技术特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">性能指标</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%A7%86%E9%A2%91%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%9D%97-sousuo-ver2-py"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 视频搜索模块 (sousuo_ver2.py)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD-1"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">核心功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E7%89%B9%E7%82%B9-1"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">技术特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87-1"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">性能指标</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AF%84%E8%AE%BA%E5%88%86%E6%9E%90%E6%A8%A1%E5%9D%97-quchong-ver4-py"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. 评论分析模块 (quchong_ver4.py)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD-2"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">核心功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E7%89%B9%E7%82%B9-2"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">技术特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%83%BD%E5%8A%9B"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">分析能力</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.4.</span> <span class="toc-text">系统架构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.</span> <span class="toc-text">基本流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.1.</span> <span class="toc-text">基本工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text">建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E6%80%A7%E4%B8%8E%E7%BB%B4%E6%8A%A4%E6%80%A7"><span class="toc-number">1.6.</span> <span class="toc-text">扩展性与维护性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%B1%95%E7%A4%BA%E4%B8%8E%E6%B3%A8%E9%87%8A"><span class="toc-number">1.7.</span> <span class="toc-text">代码展示与注释</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%A7%86%E9%A2%91%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%9D%97%EF%BC%88sousuo-ver2-py"><span class="toc-number">1.7.1.</span> <span class="toc-text">1.视频搜索模块（sousuo_ver2.py)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%AF%84%E8%AE%BA%E7%88%AC%E5%8F%96%E6%A8%A1%E5%9D%97%EF%BC%88b-ver7-py"><span class="toc-number">1.7.2.</span> <span class="toc-text">2.评论爬取模块（b_ver7.py)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AF%84%E8%AE%BA%E5%88%86%E6%9E%90%E6%A8%A1%E5%9D%97-quchong-ver4-py-1"><span class="toc-number">1.7.3.</span> <span class="toc-text">3.评论分析模块(quchong_ver4.py)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-number">1.8.</span> <span class="toc-text">结语</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/21/%E4%BB%A3%E7%A0%81%E5%8F%8A%E4%BB%A3%E7%A0%81%E9%98%90%E9%87%8A/" title="无标题">无标题</a><time datetime="2025-07-21T11:37:45.300Z" title="发表于 2025-07-21 19:37:45">2025-07-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/09/%E6%8F%89%E6%90%93%E8%B5%B7%E6%9D%A5%E7%9A%84%E6%96%87%E5%AD%97/" title="无标题">无标题</a><time datetime="2025-06-09T04:37:29.514Z" title="发表于 2025-06-09 12:37:29">2025-06-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/06/%E8%A7%86%E9%A2%91%E4%B8%8E%E7%BD%AE%E9%A1%B6%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6/" title="无标题">无标题</a><time datetime="2025-06-06T11:34:06.237Z" title="发表于 2025-06-06 19:34:06">2025-06-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/01/Lnterlink_%E4%B8%AA%E4%BA%BA%E4%BD%9C%E5%93%81%E9%9B%86/" title="个人作品集">个人作品集</a><time datetime="2025-05-31T16:00:00.000Z" title="发表于 2025-06-01 00:00:00">2025-06-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/29/%E6%96%B0%E9%97%BB%E5%AD%A6%E6%A6%82%E8%AE%BA%EF%BC%88%E4%B8%89%EF%BC%89%E6%96%B0%E9%97%BB%E5%AD%A6%E7%9A%84%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9/" title="新闻学概论（三）新闻学的主要内容">新闻学概论（三）新闻学的主要内容</a><time datetime="2025-05-29T14:00:00.000Z" title="发表于 2025-05-29 22:00:00">2025-05-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Lnterlink</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div><div class="footer_custom_text">愿作一切美好的信使</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><div id="aplayer"></div><script>
document.addEventListener('DOMContentLoaded', function() {
  new APlayer({
    container: document.getElementById('aplayer'),
    fixed: true,
    loop: 'all',
    autoplay: false,
    mutex: true,
    order: 'random',
    audio: [
      {
        title: '个人编曲作品-三月语',
        author: 'Lnterlink',
        url: '/music/三月练习.mp3',
        cover: 'https://y.qq.com/music/photo_new/T062R300x300M000000tke4v1zaB6q.jpg'
      },
      {
        title: '个人编曲作品-尾声',
        author: 'Lnterlink',
        url: '/music/尾声.mp3',
        cover: 'https://y.qq.com/music/photo_new/T062R300x300M000000tke4v1zaB6q.jpg'
      },
    ]
  });
});
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      false 
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="输入关键词搜索" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>